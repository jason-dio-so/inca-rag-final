# STEP 3.8-γ: 가입설계서 기반 담보 비교 · 고객 응답 설계 완료

**Date:** 2025-12-25
**Type:** Design & Architecture
**Status:** ✅ COMPLETED (Analysis & Design Phase)
**Branch:** N/A (Design documents only, no code implementation)

---

## Purpose

가입설계서 기반 담보 비교 시스템의 **설계 완성 (SSOT 설계)**:
1. 가입설계서 기반 담보 추출의 누락·오탐을 구조적으로 방지
2. 고객이 실제로 원하는 비교 응답 형식(비교표 + 종합평가 + 추천)을 정확히 재현

**⚠️ 이 단계는 "구현"이 아니라 분석 + 설계 + 비교 헌법 정의 단계**

---

## Deliverables

### 1. 비교 헌법 (Constitution) 요약
**파일:** `docs/STEP38γ_COMPARISON_CONSTITUTION.md`

**핵심 내용:**
- 10대 비교 시스템 원칙 정의
- 가입설계서 단일 진실 출처 원칙 (Proposal SSOT)
- 정직한 실패 원칙 (Honest Failure)
- 비교 축 고정 원칙 (5 axes: eligibility, coverage_limit, coverage_start, exclusions, enrollment_condition)
- Evidence 필수 원칙
- 결정론적 추출 원칙 (LLM/확률적 추론 금지)
- 5-State 비교 시스템 (comparable, comparable_with_gaps, non_comparable, unmapped, out_of_universe)
- 보험료 보조 원칙 (Premium as Auxiliary - API 실패 시 비교 지속)
- 응답 구조화 원칙 (자연어 추천 금지)
- 문서 우선순위 원칙 (Proposal → Summary → Business Rules → Policy)
- Fail-Fast 검증 원칙

**Constitutional Violations (헌법 위반 행위):**
- ❌ 약관 기반 비교 대상 생성/확장
- ❌ 가입설계서 없이 비교 시작
- ❌ LLM으로 coverage_code 추론/매핑
- ❌ Evidence 없는 O/X 판정
- ❌ 임의 비교 축 추가
- ❌ 자연어 추천 문구 생성
- ❌ 보험료 API 실패 시 비교 중단
- ❌ 문서 우선순위 역전
- ❌ out_of_universe 오류 무시/추정
- ❌ 불확실성 은폐

---

### 2. SSOT 스키마 (YAML)
**파일:** `docs/STEP38γ_SSOT_SCHEMA.yaml`

**핵심 구조:**

#### Part 1: Comparison Axes (비교 축 정의)
```yaml
comparison_axes:
  eligibility:
    allowed_values: ["O", "X", "△"]
    evidence_required: true
    source_documents:
      primary: "proposal"
    insurer_patterns:  # 보험사별 표현 패턴 (deterministic)
      SAMSUNG: [...]
      MERITZ: [...]
      DB: [...]

  coverage_limit:
    data_type: "integer"
    unit: "KRW"
    extraction_patterns:  # 정규식만 (LLM 금지)
      - regex: '(\d{1,3}(?:,\d{3})*)만원'

  coverage_start:
    schema:
      type: ["immediate", "waiting_period"]
      waiting_days: integer | null

  exclusions:
    schema:
      exclusion_type: ["reduction", "exemption"]
      reduction_rate: 0.0 ~ 1.0

  enrollment_condition:
    schema:
      age_min/max, coverage_period, payment_period
```

#### Part 2: Coverage Item Schema
```yaml
coverage_item:
  required_fields:
    - universe_id, insurer, canonical_coverage_code, mapping_status
  slot_fields:
    - event_type, disease_scope_raw, disease_scope_norm, waiting_period_days, ...
  unknown_value_rules:
    null: "정보 없음"
    []: "명시적 없음"
    0: "명시적 0"
```

#### Part 3: Evidence Schema
```yaml
evidence:
  required_fields:
    - document_id, doc_type, page, span_text, source_confidence
  document_priority:
    - PROPOSAL → PRODUCT_SUMMARY → BUSINESS_METHOD → POLICY
  output_order:
    1: PROPOSAL (필수)
    2: PRODUCT_SUMMARY (선택)
    3: BUSINESS_METHOD (선택)
    4: POLICY (필요 시만)
```

#### Part 4: Comparison States (5-State)
```yaml
comparison_states:
  comparable: "모든 핵심 축 일치"
  comparable_with_gaps: "일부 누락 (약관 확인 필요)"
  non_comparable: "담보 성격 다름"
  unmapped: "Excel 매핑 실패"
  out_of_universe: "가입설계서에 없음 (Universe Lock 위반)"
```

#### Part 5-8: Fail-Fast, Integrity Checks, Scalability, Prohibited Operations
- Universe Lock Enforcement (최우선)
- Mapping Validation
- Critical Slots Validation
- Amount/Evidence/Disease Scope Validation
- 보험사 신뢰도 스코어 (3개 → 8개 확장 전략)
- 금지 행위 명시

---

### 3. Guardrail Rules (안전장치 규칙)
**파일:** `docs/STEP38γ_GUARDRAIL_RULES.md`

**핵심 규칙:**

#### Fail-Fast Rules (즉시 중단)
1. **Universe Lock Enforcement** - 가입설계서 존재 확인 (최우선)
2. **Mapping Validation** - Excel 매핑 확인
3. **Critical Slots Validation** - 핵심 축 누락 검사

#### Integrity Check Rules (정합성 검증)
1. **Amount Unit Validation** - 금액 단위/범위 검증
2. **O/X Evidence Requirement** - eligibility 판정 시 evidence 필수
3. **Disease Scope Normalization Guard** - 그룹 참조만 허용 (코드 배열 금지)

#### Insurer Scalability Guards (보험사 확장)
1. **Confidence Score Threshold** - 보험사별 데이터 품질 검증
   - HIGH: mapping_rate ≥ 0.9, evidence ≥ 0.8
   - MEDIUM: mapping_rate ≥ 0.7, evidence ≥ 0.6
   - LOW: 경고 표시 (비교는 계속)
2. **Multi-Insurer Gap Handling** - 일부 보험사 out_of_universe 처리

#### Premium Integration Guards
1. **Premium API Failure Handling** - API 실패 시 비교 지속 (비교 중단 ❌)
2. **Premium Condition Enforcement** - 보험료 제시 시 조건 필수 (age, gender, payment_period)

#### Response Validation Guards
1. **Prohibited Phrases Validator** - 금지 표현 검출 ("가장 좋다", "추천", "유리" 등)
2. **Evidence Order Validator** - 문서 우선순위 순서 검증

#### Comparison-Time Guardrails
1. **Canonical Code Match Requirement** - canonical_coverage_code 일치 필수
2. **Slot Completeness Check** - 최소 슬롯 확인

#### Logging & Monitoring
1. **Extraction Failure Logging** - 모든 추출 실패 추적
2. **Comparison Quality Metrics** - 비교 품질 지표 (evidence/slot completeness)

#### Constitutional Violation Detector
1. **Universe Lock Violation Detector** - 약관 기반 비교 대상 생성 감지
2. **LLM Inference Violation Detector** - LLM 기반 추론 감지

**Guardrail Execution Order:** 15단계 순차 검증 (Universe Lock → ... → Logging)

---

### 4. Response Contract (고객 응답 계약)
**파일:** `docs/STEP38γ_RESPONSE_CONTRACT.md`

**3단 응답 구조:**

#### Part 1: 비교 표 (Fact Table)
```json
{
  "comparison_table": {
    "axes": {
      "eligibility": {
        "SAMSUNG": {"value": "O", "evidence": {...}},
        "MERITZ": {"value": "O", "evidence": {...}},
        "DB": {"value": "O", "evidence": {...}}
      },
      "coverage_limit": {
        "SAMSUNG": {"value": 30000000, "display": "3,000만원"},
        "MERITZ": {"value": 30000000, "display": "3,000만원"},
        "DB": {"value": 60000000, "display": "6,000만원"}
      },
      // ... coverage_start, exclusions, enrollment_condition
    }
  }
}
```
**규칙:**
- ✅ O/X/△/금액만 허용
- ❌ 감정 표현 금지
- ✅ 모든 셀은 evidence에 매핑

#### Part 2: 종합 평가 (Rule-based Summary)
```json
{
  "rule_based_summary": {
    "evaluated_dimensions": [
      {
        "dimension": "coverage_amount",
        "rule": "max_amount_insurer",
        "result": {
          "insurer": "DB",
          "value": 60000000,
          "comparison": {
            "SAMSUNG": "50% 낮음",
            "MERITZ": "50% 낮음"
          }
        }
      },
      // ... coverage_start_speed, reduction_burden, enrollment_flexibility, premium
    ]
  }
}
```
**규칙:**
- ✅ 사전 정의 규칙만 (Rule Registry)
- ❌ LLM 주관 평가 금지
- ✅ 수치 비교 + 사실 진술만

#### Part 3: 추천 (Conditional Guidance)
```json
{
  "conditional_guidance": {
    "conditions": [
      {
        "condition_text": "보장금액을 우선하는 경우",
        "recommended_insurer": "DB",
        "reason": {
          "primary": "보장금액 6,000만원 (타사 대비 2배)",
          "secondary": "즉시 보장 (대기기간 없음)"
        }
      },
      {
        "condition_text": "보험료를 우선하는 경우",
        "recommended_insurer": "SAMSUNG",
        "reason": {...}
      },
      // ... 조건별 분기
    ]
  }
}
```
**규칙:**
- ✅ 조건 분기형만 허용 (`IF {우선순위} THEN {보험사} BECAUSE {근거}`)
- ❌ "A가 더 좋다", "추천합니다" 금지

---

## Complete Response Examples (3 Scenarios)

### Scenario 1: 3사 비교 성공 (보험료 포함)
**Query:** "일반암진단비 비교해주세요 (30세 남성, 20년납 기준)"

**Response:**
- `comparison_state`: "comparable"
- `comparison_table`: 5개 축 완비 (eligibility, coverage_limit, coverage_start, exclusions, enrollment_condition)
- `rule_based_summary`: 4개 dimension (coverage_amount, coverage_start_speed, reduction_burden, premium)
- `conditional_guidance`: 3개 조건 (보장금액 우선 → DB, 보험료 우선 → SAMSUNG, 균형 → MERITZ)
- `prohibited_phrases_check`: "PASS"

### Scenario 2: 보험료 API 실패 (비교 지속)
**Query:** "일반암진단비 비교해주세요"

**Response:**
- `comparison_state`: "comparable"
- `comparison_table`: 정상 (보험료 제외)
- `rule_based_summary`: premium dimension = `unavailable: true`
- `conditional_guidance`: 보험료 조건은 `premium_required: true`, `recommended_insurer: null`
- `warnings`: ["보험료 정보 없음"]
- **비교 중단 ❌, 비교 지속 ✅**

### Scenario 3: 일부 보험사 out_of_universe
**Query:** "특정희귀질환진단비 비교해주세요"

**Response:**
- `comparison_state`: "out_of_universe"
- `error`: "partial_out_of_universe"
- `details`: SAMSUNG (out), MERITZ (in), DB (out)
- `comparison_allowed`: false
- `reason`: "3사 중 1사만 가입설계서에 담보 존재 (비교 불가)"

---

## Premium Integration Strategy

### Premium API 연동 방식
```
User Query
  ↓
Universe Lock Check
  ↓
Mapping Validation
  ↓
Comparison Table 생성
  ↓
[Premium API Call]  ← 병렬 호출 (비동기 가능)
  ↓
Rule-based Summary (보험료 포함/제외)
  ↓
Conditional Guidance 생성
```

### Failure Handling
```python
def handle_premium_api_failure(error: Exception) -> dict:
    log_error(f"Premium API failed: {error}")
    return {
        "premium_available": False,
        "premium_error": {
            "message": "보험료 정보를 가져올 수 없습니다.",
            "fallback_action": "comparison_continues"
        },
        "comparison_continues": True  # 비교는 계속
    }
```

**Critical Rule:**
```
Premium API 실패 → 비교 중단 ❌
Premium API 실패 → 보험료 제외하고 비교 지속 ✅
```

---

## Constitutional Compliance Checklist

### Article I: Coverage Universe Lock
- ✅ 신정원 통일 담보 코드 = 유일한 기준
- ✅ Excel = canonical code 단일 출처
- ✅ 가입설계서 = 비교 Universe 단일 출처

### Article II: Deterministic Compiler Principle
- ✅ LLM/확률적 추론 금지 (coverage mapping, disease_scope_norm)
- ✅ 규칙 기반 추출만 허용 (regex, table, YAML)
- ✅ Evidence 필수 (document span reference)

### Article III: Evidence Rule
- ✅ 모든 확정값은 document_id, page, span_text 필수
- ✅ source_confidence 명시 (proposal_confirmed | policy_required | unknown)

### Article VIII: Disease Code Authority
- ✅ KCD-7 공식 배포본 = 유일한 질병코드 출처
- ✅ 보험 개념 ≠ 질병코드 (3-tier 분리)
- ✅ insurer=NULL은 의학적 범위만 허용

### Article X: Document Priority (신규)
- ✅ Proposal → Summary → Business Rules → Policy 순서 고정
- ✅ 약관은 "어떻게 해석할 것인가"만 담당
- ✅ "무엇을 비교할 것인가"는 가입설계서만 결정

---

## Definition of Done

### Deliverables Checklist
- ✅ Constitution 문서 작성 (10대 원칙)
- ✅ SSOT Schema 작성 (YAML - 8 parts)
- ✅ Guardrail Rules 작성 (9 categories, 15-step execution order)
- ✅ Response Contract 작성 (3-tier structure + 3 scenarios)
- ✅ Premium Integration Strategy 정의

### Design Completeness
- ✅ 비교 축 5개 고정 (eligibility, coverage_limit, coverage_start, exclusions, enrollment_condition)
- ✅ 5-State 비교 시스템 명시
- ✅ Evidence Schema 정의
- ✅ Document Priority 고정 (4-tier)
- ✅ Prohibited Operations 명시 (10개)

### Scalability Assurance
- ✅ 보험사 3개 → 8개 확장 시 구조 변경 없음
- ✅ 보험사별 신뢰도 스코어 전략
- ✅ Premium API 연동/미연동 모두 대응
- ✅ 일부 보험사 out_of_universe 처리

### Constitutional Integrity
- ✅ NO 약관 기반 비교 대상 생성
- ✅ NO LLM 기반 추론/매핑
- ✅ NO Evidence 없는 판정
- ✅ NO 임의 비교 축 추가
- ✅ NO 자연어 추천 문구
- ✅ NO Premium API 실패 시 비교 중단
- ✅ NO 문서 우선순위 역전
- ✅ NO 불확실성 은폐

---

## Next Steps (Implementation Phase)

**STEP 3.8-γ는 설계 단계이므로 구현은 별도 단계에서 진행:**

### Phase 1: Comparison Axes Implementation
- Axis-specific extractors (eligibility, coverage_limit, coverage_start, exclusions, enrollment_condition)
- Insurer pattern matching (regex-based)
- Fail-fast validation (Universe Lock → Mapping → Critical Slots)

### Phase 2: Response Contract Implementation
- Fact Table generator
- Rule-based Summary engine (Rule Registry)
- Conditional Guidance generator (condition branching)
- Prohibited phrases validator

### Phase 3: Premium Integration
- Premium API client
- Failure handling (비교 지속)
- Condition enforcement (age, gender, payment_period)

### Phase 4: Guardrail Integration
- 15-step validation pipeline
- Insurer confidence scoring
- Constitutional violation detector
- Logging & monitoring

### Phase 5: E2E Testing
- 3 scenarios (보험료 포함, 보험료 실패, out_of_universe)
- Prohibited phrases validation
- Evidence completeness check
- Response schema validation

---

## Files Created

1. `docs/STEP38γ_COMPARISON_CONSTITUTION.md` - 비교 헌법 (10대 원칙)
2. `docs/STEP38γ_SSOT_SCHEMA.yaml` - SSOT 스키마 (8 parts)
3. `docs/STEP38γ_GUARDRAIL_RULES.md` - Guardrail 규칙 (9 categories)
4. `docs/STEP38γ_RESPONSE_CONTRACT.md` - 응답 계약 (3-tier + 3 scenarios)
5. `docs/status/2025-12-25_step-38-gamma.md` - 본 문서

---

## Related Documents

- `CLAUDE.md` - Constitutional requirements (문서 우선순위 원칙)
- `docs/STEP9_proposal_based_comparison.md` - 가입설계서 중심 3사 비교
- `docs/STEP10_user_response_contract.md` - 사용자 응답 계약 (STEP 10)
- `apps/api/app/schemas/compare_response.schema.json` - API response schema (STEP 10-C)

---

**Status:** ✅ COMPLETED (Design Phase)
**Next:** Implementation Phase (TBD)
