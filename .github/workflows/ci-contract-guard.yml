name: CI Contract Guard - Compare API

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

jobs:
  contract-enforcement:
    name: Compare API Runtime Contract Enforcement
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for diff comparison

      - name: Verify Golden Snapshot Changes Are Approved (STEP 21)
        run: |
          echo "Checking if golden snapshot changes have approval documentation..."

          # Determine base ref for comparison
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            BASE_REF="origin/${{ github.base_ref }}"
            echo "PR mode: comparing against ${BASE_REF}"
          else
            BASE_REF="HEAD~1"
            echo "Push mode: comparing against ${BASE_REF}"
          fi

          # Check for golden snapshot changes
          GOLDEN_CHANGES=$(git diff --name-only ${BASE_REF}...HEAD | grep '^tests/snapshots/compare/.*\.golden\.json$' || true)

          if [ -n "$GOLDEN_CHANGES" ]; then
            echo "Golden snapshot changes detected:"
            echo "$GOLDEN_CHANGES"

            # Check for CHANGELOG update
            CHANGELOG_CHANGED=$(git diff --name-only ${BASE_REF}...HEAD | grep '^docs/contracts/CHANGELOG\.md$' || true)

            if [ -z "$CHANGELOG_CHANGED" ]; then
              echo ""
              echo "ERROR: Golden snapshot changes detected without CHANGELOG approval"
              echo ""
              echo "Changed files:"
              echo "$GOLDEN_CHANGES"
              echo ""
              echo "REQUIRED ACTION:"
              echo "  1. Add entry to docs/contracts/CHANGELOG.md"
              echo "  2. Include: date, STEP, change type, affected scenarios, reason, approver"
              echo "  3. Commit CHANGELOG with golden snapshot changes"
              echo ""
              echo "This is a STEP 21 contract governance violation."
              echo "Golden snapshots are API contracts and require explicit approval."
              exit 1
            else
              echo "CHANGELOG update detected ✓"
              echo "Golden change approval process satisfied"
            fi
          else
            echo "No golden snapshot changes detected ✓"
          fi

      - name: Verify Compare Code Registry Changes Are Approved (STEP 25)
        run: |
          echo "Checking if compare code registry changes have approval documentation..."

          # Determine base ref for comparison
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            BASE_REF="origin/${{ github.base_ref }}"
            echo "PR mode: comparing against ${BASE_REF}"
          else
            BASE_REF="HEAD~1"
            echo "Push mode: comparing against ${BASE_REF}"
          fi

          # Check for registry changes
          REGISTRY_CHANGES=$(git diff --name-only ${BASE_REF}...HEAD | grep '^apps/api/app/contracts/compare_codes\.py$' || true)

          if [ -n "$REGISTRY_CHANGES" ]; then
            echo "Compare code registry changes detected:"
            echo "$REGISTRY_CHANGES"

            # Check for CHANGELOG update
            CHANGELOG_CHANGED=$(git diff --name-only ${BASE_REF}...HEAD | grep '^docs/contracts/CHANGELOG\.md$' || true)

            if [ -z "$CHANGELOG_CHANGED" ]; then
              echo ""
              echo "ERROR: Compare code registry change detected without CHANGELOG approval"
              echo ""
              echo "Changed files:"
              echo "$REGISTRY_CHANGES"
              echo ""
              echo "REQUIRED ACTION:"
              echo "  1. Add entry to docs/contracts/CHANGELOG.md"
              echo "  2. Include: date, STEP, change type, affected codes, reason, approver"
              echo "  3. Commit CHANGELOG with registry changes"
              echo ""
              echo "This is a STEP 25 contract governance violation."
              echo "Registry changes are contract changes and require explicit approval."
              echo ""
              echo "Affected registry: apps/api/app/contracts/compare_codes.py"
              echo "  - ALLOWED_COMPARISON_RESULTS: comparable, unmapped, policy_required, out_of_universe"
              echo "  - ALLOWED_NEXT_ACTIONS: COMPARE, REQUEST_MORE_INFO, VERIFY_POLICY"
              exit 1
            else
              echo "CHANGELOG update detected ✓"
              echo "Registry change approval process satisfied"
            fi
          else
            echo "No compare code registry changes detected ✓"
          fi

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install pip-tools
        run: |
          python -m pip install --upgrade pip
          pip install pip-tools

      - name: Install dependencies from lock file
        run: |
          pip install -r apps/api/requirements.lock

      - name: Verify Docker installation
        run: |
          docker --version
          docker compose version

      - name: Start Docker services (STEP 14 compose)
        run: |
          echo "Starting Docker services with STEP 14-only compose..."
          docker compose -f docker-compose.step14.yml down -v || true
          docker compose -f docker-compose.step14.yml up -d || {
            echo "ERROR: Failed to start Docker services"
            docker compose -f docker-compose.step14.yml logs
            exit 1
          }

      - name: Wait for PostgreSQL to be ready
        run: |
          echo "Waiting for PostgreSQL to be ready (max 30s)..."
          timeout 30 bash -c 'until docker exec inca_pg_step14 pg_isready -U postgres 2>/dev/null; do sleep 1; done' || {
            echo "ERROR: PostgreSQL did not become ready within 30 seconds"
            docker logs inca_pg_step14
            exit 1
          }
          echo "PostgreSQL is ready ✓"

      - name: Apply schema migration
        run: |
          echo "Applying schema migration..."
          cat docs/db/schema_universe_lock_minimal.sql | docker exec -i inca_pg_step14 psql -U postgres -d inca_rag_final || {
            echo "ERROR: Schema migration failed"
            exit 1
          }
          echo "Schema migration complete ✓"

      - name: Apply seed data
        run: |
          echo "Applying seed data..."
          cat docs/db/seed_step13_minimal.sql | docker exec -i inca_pg_step14 psql -U postgres -d inca_rag_final || {
            echo "ERROR: Seed data application failed"
            exit 1
          }
          echo "Seed data complete ✓"

      - name: Wait for API to be ready
        run: |
          echo "Waiting for API to be ready (max 30s)..."
          timeout 30 bash -c 'until curl -s http://localhost:8000/health > /dev/null 2>&1; do sleep 1; done' || {
            echo "ERROR: API did not become ready within 30 seconds"
            docker logs inca_api_step14
            exit 1
          }
          echo "API is ready ✓"

      - name: Run STEP 14 API E2E Tests
        run: |
          env E2E_DOCKER=1 python -m pytest tests/e2e/test_step14_api_compare_e2e.py -v
        env:
          E2E_DOCKER: "1"

      - name: Verify Canonical Snapshot Format (STEP 20)
        run: |
          echo "Verifying golden snapshots are in canonical JSON format..."
          env E2E_DOCKER=1 python -m pytest tests/e2e/test_step16_runtime_contract_freeze.py::TestSTEP16RuntimeContractFreeze::test_snapshot_canonical_json_policy -v || {
            echo "ERROR: Golden snapshots are not in canonical JSON format"
            echo "This is a STEP 20 contract violation"
            echo "Snapshots must be stored with sort_keys=True, indent=4, ensure_ascii=False"
            exit 1
          }
          echo "Canonical format verified ✓"

      - name: Run STEP 16 Runtime Contract Freeze Tests
        run: |
          env E2E_DOCKER=1 python -m pytest tests/e2e/test_step16_runtime_contract_freeze.py -v
        env:
          E2E_DOCKER: "1"

      - name: Run STEP 24 Code Registry Contract Tests
        run: |
          echo "Verifying comparison_result/next_action codes against SSOT registry..."
          env E2E_DOCKER=1 python -m pytest tests/e2e/test_step24_code_registry_contract.py -v || {
            echo "ERROR: Unknown comparison_result or next_action code detected"
            echo "This is a STEP 24 contract violation"
            echo "Update apps/api/app/contracts/compare_codes.py or fix API logic"
            exit 1
          }
          echo "Code registry contract verified ✓"
        env:
          E2E_DOCKER: "1"

      - name: Verify Golden Snapshots Unchanged
        run: |
          # Fail if golden snapshots were modified during test run
          git diff --exit-code tests/snapshots/compare/ || {
            echo "ERROR: Golden snapshots were modified during test run"
            echo "This is a violation of STEP 16/17/20 contract policy"
            exit 1
          }

      - name: Cleanup Docker services
        if: always()
        run: |
          docker compose -f docker-compose.step14.yml down -v || true

      - name: Report contract enforcement status
        if: success()
        run: |
          echo "✅ All runtime contracts enforced:"
          echo "   - STEP 14: API E2E (22 tests)"
          echo "   - STEP 16: Runtime Contract Freeze (10 tests)"
          echo "   - STEP 17: Contract interpretation alignment"
          echo "   - STEP 21: Golden Change Approval Protocol"
          echo "   - STEP 24: Code Registry Contract (8 tests)"
          echo "   - STEP 25: Registry Change Approval Protocol"
          echo "   - Golden snapshots: UNCHANGED"
          echo "   - Code registry: UNCHANGED or APPROVED"
