# inca-RAG-final Project Status

**Last Updated:** 2025-12-26
**Current Phase:** STEP NEXT-9 Documentation Complete (INCA DIO Requirements Lock)
**Project Health:** âœ… ACTIVE - Customer Requirements Compiled

---

## Quick Overview

**inca-RAG-final** is a proposal-centered insurance policy comparison RAG system implementing Constitutional principles defined in [CLAUDE.md](CLAUDE.md).

**Core Principles:**
- Proposal-centered (not policy-centered)
- Coverage Universe Lock (ê°€ì…ì„¤ê³„ì„œ = SSOT)
- Deterministic extraction (no LLM inference for mappings)
- Evidence-based everything
- /compare contract immutability

**Repository:** [GitHub - inca-rag-final](https://github.com/jason-dio-so/inca-rag-final)

---

## Latest Milestones (Summary)

Detailed implementation logs available in [`docs/status/`](docs/status/).

### âœ… STEP NEXT-8B: CLAUDE.md Consistency Recovery (Complete)
**Commit:** [pending] | **Date:** 2025-12-26

**Summary:**
- CLAUDE.md ì „ì²´ ì •í•©ì„± íšŒë³µ (ë³¸ë¬¸ ê·œì¹™ â†” Decision Change Log ì¼ì¹˜)
- ê¸ˆì§€ ì‚¬í•­ í™•ì¥ (ì½”ë“œ/ë°ì´í„° + ë§¤í•‘/ì¶”ì¶œ + UI/ì‘ë‹µ ë ˆë²¨ ë¶„ë¦¬)
- Deterministic Compiler ì ìš© ë²”ìœ„ ëª…í™•í™” (ì „ êµ¬ê°„: ë°ì´í„° ì¶”ì¶œ ~ UI ì‘ë‹µ)
- Decision Change Log ì¶”ê°€ (ë³€ê²½ ì´ë ¥ ëª…ì‹œì  ê¸°ë¡)
- í˜„í–‰ ì‹œìŠ¤í…œ ìƒíƒœ ì—…ë°ì´íŠ¸ (2025-12-26, main branch)

**ëª©ì :**
- ê¸°ì¡´ ë¬¸ì„œ ê°„ ì¶©ëŒ ì œê±°
- ìµœì‹  ê²°ì • ì‚¬í•­ì„ ë³¸ë¬¸ ê·œì¹™ì— ì™„ì „íˆ ë°˜ì˜
- í—Œë²• ì‹ ë¢°ì„± íšŒë³µ (ì•”ë¬µì  ì¶”ë¡  ë°©ì§€)

**ë³€ê²½ ì„±ê²©:**
- **ê·œì¹™ ìˆ˜ì • / ì¶©ëŒ ì œê±°** (ê¸°ëŠ¥ ì¶”ê°€ ì—†ìŒ)
- ë¬¸ì„œ ì •í•©ì„± ì‘ì—…ë§Œ ìˆ˜í–‰

**ì£¼ìš” ë³€ê²½ ì‚¬í•­:**

1. **ê¸ˆì§€ ì‚¬í•­ ì¬êµ¬ì¡°í™” (10ê°œ â†’ 15ê°œ)**
   - ì½”ë“œ/ë°ì´í„° ë ˆë²¨: 1~6ë²ˆ (ê¸°ì¡´)
   - ë§¤í•‘/ì¶”ì¶œ ë ˆë²¨: 7~10ë²ˆ (ê¸°ì¡´)
   - **UI/ì‘ë‹µ ë ˆë²¨: 11~15ë²ˆ (ì‹ ê·œ ì¶”ê°€)**
     - ì¶”ì²œ ë¬¸êµ¬ ìƒì„± ê¸ˆì§€
     - ìš°ì—´ íŒë‹¨ í‘œí˜„ ê¸ˆì§€
     - í•´ì„ ë¬¸êµ¬ ê¸ˆì§€
     - ì¶”ë¡  ê¸°ë°˜ ì‘ë‹µ ê¸ˆì§€
     - LLM ìƒì„± ì‘ë‹µ ë¬¸êµ¬ ê¸ˆì§€ (í…œí”Œë¦¿ë§Œ í—ˆìš©)

2. **Deterministic Compiler ì ìš© ë²”ìœ„ í™•ì¥**
   - Before: ë°ì´í„° ì¶”ì¶œë§Œ
   - After: ë°ì´í„° ì¶”ì¶œ / ë§¤í•‘ / **UI ì‘ë‹µ** / **ë¹„êµ ê²°ê³¼ ìƒì„±** ì „ êµ¬ê°„
   - UI ì‘ë‹µ ë¬¸êµ¬ ìƒì„± ê¸ˆì§€ ì¶”ê°€
   - ë¹„êµ ê²°ê³¼ í•´ì„/ì¶”ë¡  ê¸ˆì§€ ì¶”ê°€
   - ê³ ì • í…œí”Œë¦¿ ê¸°ë°˜ ì‘ë‹µ ìƒì„±ë§Œ í—ˆìš©

3. **Decision Change Log ì¶”ê°€**
   - 2025-12-26 ë³€ê²½ ì‚¬í•­ 7ê±´ ê¸°ë¡
   - "After" ë‚´ìš©ì´ ë³¸ë¬¸ ê·œì¹™ë³´ë‹¤ ìš°ì„ í•¨ì„ ëª…ì‹œ
   - ì•”ë¬µì  ì¶”ë¡  ë°©ì§€ ëª©ì 

4. **í˜„í–‰ ì‹œìŠ¤í…œ ìƒíƒœ ì—…ë°ì´íŠ¸**
   - ë‚ ì§œ: 2025-12-24 â†’ 2025-12-26
   - ë¸Œëœì¹˜: feature/proposal-universe-lock-v1 â†’ main
   - ì™„ë£Œ ë‹¨ê³„: NEXT-8A í¬í•¨
   - í•µì‹¬ ëª¨ë“ˆ: ìµœì‹  êµ¬ì¡° ë°˜ì˜

**ì •í•©ì„± ê²€ì¦ ì²´í¬ë¦¬ìŠ¤íŠ¸:**
- âœ… ê³ ê° ìš”êµ¬ì‚¬í•­ SSOT (data/inca-dio.pdf) ëª…í™•íˆ ê³ ì •
- âœ… data/í˜¸ì¶œ_api/ ë³´ë¥˜ ëª…ì‹œ
- âœ… ChatGPT UI ëª©í‘œ êµ¬ì²´í™” (ì¢Œ: ì§ˆì˜ / ìš°: ê·¼ê±° íŒ¨ë„)
- âœ… ì¶”ì²œ/ìš°ì—´/í•´ì„ ê¸ˆì§€ ì „ êµ¬ê°„ ì ìš© (UI/ì‘ë‹µ ë ˆë²¨ ì¶”ê°€)
- âœ… Deterministic compiler UI/ì‘ë‹µ ë‹¨ê³„ê¹Œì§€ í™•ì¥
- âœ… Decision Change Log ë³¸ë¬¸ ê·œì¹™ë³´ë‹¤ ìš°ì„ í•¨ ëª…ì‹œ
- âœ… ë³¸ë¬¸ ê·œì¹™ â†” Decision Change Log ì¶©ëŒ 0ê±´

**DoD Achievement:**
- âœ… Decision Change Log â†” ë³¸ë¬¸ ê·œì¹™ ì¶©ëŒ ì œê±°
- âœ… ê¸ˆì§€ ì‚¬í•­ UI/ì‘ë‹µ ë ˆë²¨ í™•ì¥ (11~15ë²ˆ)
- âœ… Deterministic Compiler ì „ êµ¬ê°„ ì ìš©
- âœ… í˜„í–‰ ì‹œìŠ¤í…œ ìƒíƒœ ìµœì‹ í™”
- âœ… ìƒˆ ì„¤ê³„Â·êµ¬í˜„ ì¶”ê°€ ì—†ìŒ (ë¬¸ì„œ ì •í•©ì„±ë§Œ)
- âœ… STATUS.md NEXT-8B ê¸°ë¡
- â³ git commit + push (pending)

**Constitutional Compliance:**
- âœ… êµ¬í˜„ì´ ì•„ë‹Œ í—Œë²• ì •ë¹„ (documentation only)
- âœ… ì¶”ë¡ /ì„¤ê³„ í™•ì¥/ê¸°ëŠ¥ ì¶”ê°€ ì—†ìŒ
- âœ… ê¸°ì¡´ ê²°ì • ì‚¬í•­ì˜ ë³¸ë¬¸ ë°˜ì˜ë§Œ ìˆ˜í–‰

**ì˜í–¥ ë²”ìœ„:**
- ë¬¸ì„œë§Œ (CLAUDE.md)
- ì½”ë“œ ë³€ê²½ ì—†ìŒ
- ë°ì´í„° ë³€ê²½ ì—†ìŒ

**ë‹¤ìŒ ë‹¨ê³„ë¡œ ë„˜ì–´ê°ˆ ìˆ˜ ìˆëŠ” ì¡°ê±´:**
- âœ… CLAUDE.md + data/inca-dio.pdf = ë‹¨ì¼ ì‘ì—… ê¸°ì¤€ í™•ë¦½
- âœ… í—Œë²• ë‚´ë¶€ ì¶©ëŒ 0ê±´
- âœ… Decision Change Log ìœ ì§€ë³´ìˆ˜ í”„ë¡œì„¸ìŠ¤ í™•ë¦½

---

### âœ… STEP NEXT-8A: CLAUDE.md SSOT Entry Point Lock (Complete)
**Commit:** ba019e2 | **Date:** 2025-12-26

**Summary:**
- CLAUDE.md ìµœìƒë‹¨ì— SSOT ë°°ë„ˆ ì„¹ì…˜ ì¶”ê°€ (ğŸ”´ SSOT ENTRY POINT)
- ê³ ê° ìš”êµ¬ì‚¬í•­ ë²”ìœ„ ì„ ì–¸ (Customer Intent Lock)
- ë³´í—˜ë£Œ/ìš”ìœ¨ ê¸°ëŠ¥ ë³´ë¥˜ ì›ì¹™ ëª…ë¬¸í™”
- Claude ì‘ì—… ë°©ì‹ ê°•ì œ ê·œì¹™ ì¶”ê°€
- ëŒ€í™” ê¸°ì–µ/ì¶”ë¡  ì˜ì¡´ ì°¨ë‹¨, ë ˆí¬ ë‚´ CLAUDE.md = ìœ ì¼í•œ ì‹¤í–‰ í—Œë²•

**ëª©ì :**
- Claudeì˜ ì•”ë¬µì  ì¶”ë¡ /ëŒ€í™” ê¸°ì–µ ì˜ì¡´ì„ ì™„ì „íˆ ì°¨ë‹¨
- CLAUDE.md + data/inca-dio.pdfë¥¼ ìœ ì¼í•œ ì‘ì—… ê¸°ì¤€ìœ¼ë¡œ ê³ ì •
- ëº‘ëº‘ì´ ë°©ì§€ (ë¬´ì—‡ì„ í•˜ê³ , ë¬´ì—‡ì„ í•˜ì§€ ì•ŠëŠ”ì§€ ëª…ì‹œ)

**ì¶”ê°€ëœ ì„¹ì…˜:**
1. **ğŸ”´ SSOT ENTRY POINT (MANDATORY)**
   - ê³ ê° ìš”êµ¬ì‚¬í•­ ë‹¨ì¼ ì¶œì²˜: data/inca-dio.pdf
   - í˜„ì¬ ë‹¨ê³„ ì‚¬ìš© ë°ì´í„°: ë³´í—˜ìš©ì–´, ê°€ì…ì„¤ê³„ì„œ, ì•½ê´€, ì‚¬ì—…ë°©ë²•ì„œ, ìƒí’ˆìš”ì•½ì„œ
   - í˜„ì¬ ë‹¨ê³„ ë³´ë¥˜: data/í˜¸ì¶œ_api/ (ë³´í—˜ë£Œ ê¸°ëŠ¥)
   - UI ëª©í‘œ: ChatGPT ìŠ¤íƒ€ì¼ (ì¢Œì¸¡ ì§ˆì˜, ìš°ì¸¡ ê·¼ê±° íŒ¨ë„)
   - ê¸ˆì§€ ì‚¬í•­: ì¶”ì²œ/ìš°ì—´/í•´ì„/ì¶”ë¡ 
   - ì‘ì—… ì‹œì‘ ê·œì¹™: CLAUDE.md + inca-dio.pdf í•„ìˆ˜ í™•ì¸

2. **ê³ ê° ìš”êµ¬ì‚¬í•­ ë²”ìœ„ ì„ ì–¸ (Customer Intent Lock)**
   - 1ì°¨ ëª©í‘œ: ë³´í—˜ìƒí’ˆ AI ê°€ì´ë“œ (ChatGPT UI)
   - FAQ â‘ â‘¦, ì˜ˆì œ 14 = ê¸°ëŠ¥ ìš”êµ¬ì‚¬í•­ (ì°¸ê³  ì˜ˆì‹œ ì•„ë‹˜)
   - ì‹œìŠ¤í…œ ëª©ì : ì§ˆì˜ êµ¬ì¡°í™” + ê°€ì…ì„¤ê³„ì„œ ê¸°ì¤€ ë¹„êµ + ê·¼ê±° ì œì‹œ
   - ë³´í—˜ë£Œ ê³„ì‚°/ë¹„êµ: í˜„ ë²”ìœ„ ì œì™¸

3. **ë³´í—˜ë£Œ/ìš”ìœ¨ ê¸°ëŠ¥ ë³´ë¥˜ ì›ì¹™**
   - data/í˜¸ì¶œ_api/ = ì½ê¸°/êµ¬í˜„/ì—°ê²° ê¸ˆì§€
   - ë³´í—˜ë£Œ ê¸°ëŠ¥ì€ ë³„ë„ STEP (UI/ë¹„êµ/ë‹´ë³´ êµ¬ì¡° ê³ ì • ì´í›„)

4. **Claude ì‘ì—… ë°©ì‹ (ê°•ì œ)**
   - CLAUDE.md ë²”ìœ„ ë°– ë³€ê²½ ê¸ˆì§€ (ë¬¸ì„œ ìˆ˜ì • PR ë¨¼ì €)
   - "ë­˜ ë” í•´ì¤„ê¹Œ?" ì§ˆë¬¸ ê¸ˆì§€
   - ì‘ë‹µ ìœ í˜•: ì„¤ê³„/êµ¬í˜„/ë¬¸ì„œ ìˆ˜ì •/ë³´ë¥˜ ì‚¬ìœ  ëª…ì‹œë§Œ í—ˆìš©

**DoD Achievement:**
- âœ… CLAUDE.md ìµœìƒë‹¨ì— SSOT ë°°ë„ˆ ì¶”ê°€
- âœ… ê³ ê° ìš”êµ¬ì‚¬í•­ ë²”ìœ„ / ë³´í—˜ë£Œ ë³´ë¥˜ ê·œì¹™ ëª…ë¬¸í™”
- âœ… Claude ì‘ì—… ë°©ì‹ ê°•ì œ ì„¹ì…˜ ì¶”ê°€
- âœ… STATUS.md ì—…ë°ì´íŠ¸ (NEXT-8A í•­ëª©)
- â³ git commit + push (pending)

**Constitutional Compliance:**
- âœ… êµ¬í˜„ì´ ì•„ë‹Œ í—Œë²• ì •ë¹„ (documentation only)
- âœ… ì¶”ë¡ /ì„¤ê³„ í™•ì¥/ê¸°ëŠ¥ ì¶”ê°€ ì—†ìŒ
- âœ… ë¬¸ì„œ í˜„í–‰í™”ì—ë§Œ ì§‘ì¤‘

**Next Steps:**
- Git commit + push
- ì´í›„ ëª¨ë“  ì‘ì—…ì€ CLAUDE.md + inca-dio.pdf ê¸°ì¤€ìœ¼ë¡œë§Œ ì§„í–‰

---

### âœ… STEP NEXT-7: Admin Mapping Workbench (Complete)
**Commit:** 946e1e4 | **Date:** 2025-12-26
**Stabilization-Î²:** 8562a1f | **Date:** 2025-12-26
**Stabilization-Î³:** eb5704d | **Date:** 2025-12-26
**Stabilization-Î´:** 86fc1da | **Date:** 2025-12-26

**Summary:**
- Backend: Admin mapping service with canonical coverage rule enforcement
- Backend: `/admin/mapping/*` endpoints (queue, approve, reject, snooze)
- Database: 4 new tables (mapping_event_queue, coverage_code_alias, coverage_name_map, admin_audit_log)
- Frontend: Admin UI at `/admin/mapping` (queue + detail + approval workflow)
- Integration: Event population from compare/clarify flow
- Tests: 6 comprehensive backend tests (async fixtures fixed, DB required)
- Constitutional compliance: Canonical Coverage Rule + Safe Defaults + Auditable

**NEXT-7-Î² Stabilization:**
- Backend Root Consolidation: Moved `src/admin_mapping/` â†’ `apps/api/app/admin_mapping/`
- Single Backend Root: `apps/api/app/` is now the only backend root (Constitutional: Single Backend Root)
- DB Pool: Added asyncpg support to `apps/api/app/db.py` for admin operations
- Router Registration: Admin mapping router registered in `apps/api/app/main.py`
- Async Pool Cleanup: Shutdown handler added for async pool
- Core Tests: 231 tests still passing (no regression)

**NEXT-7-Î³ Stabilization:**
- Tests Restored: `tests/test_admin_mapping_approve.py` fully restored (no .skip)
- Async Fixtures Fixed: pytest_asyncio decorators applied correctly
- Test Coverage: 6 comprehensive tests (create, approve, invalid code, reject, snooze, dedupe)
- Smoke Tests: Complete documentation in `docs/admin/STEP_NEXT7_GAMMA_SMOKE_TESTS.md`
- Deployment Ready: Migration verified safe, API endpoints documented, UI workflow tested
- Constitutional: No skip/xfail markers (tests require DB but are production-ready)

**NEXT-7-Î´ Stabilization:**
- Docker Compose: Test-specific DB environment (`docker-compose.test.yml`)
- Migration Script: One-command migration application (`tools/db/apply_migrations_next7.sh`)
- Test Runner: One-command test execution (`tools/test/run_admin_mapping_tests.sh`)
- DB Reflection: Tests verify coverage_name_map + audit_log row creation
- Conflict Test: Restored test_approve_event_conflict (safe defaults verification)
- Test Count: 7 comprehensive tests (added conflict scenario)
- Execution Log: Complete smoke test documentation in `docs/admin/STEP_NEXT7_DELTA_SMOKE_LOG.md`

**Key Features:**
1. **Event Queue Management**: UNMAPPED/AMBIGUOUS events auto-collected with deduplication
2. **Canonical Code Validation**: All approvals validated against ì‹ ì •ì› í†µì¼ì½”ë“œ
3. **Conflict Detection**: Safe defaults - reject on alias/name conflicts (no auto-overwrite)
4. **Audit Trail**: Complete before/after tracking for all admin actions
5. **Resolution Types**: ALIAS (ë³„ì¹­ ë“±ë¡) / NAME_MAP (ë‹´ë³´ëª… ë§¤í•‘) / MANUAL_NOTE

**Module Structure:**
```
apps/api/app/admin_mapping/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ models.py (Pydantic schemas, 5-state event model)
â”œâ”€â”€ service.py (AdminMappingService with validation)
â”œâ”€â”€ router.py (FastAPI endpoints)
â””â”€â”€ integration.py (compare flow integration)

migrations/
â””â”€â”€ step_next7_admin_mapping_workbench.sql (4 tables + triggers)

apps/web/src/pages/
â”œâ”€â”€ admin/mapping.tsx (Admin UI)
â””â”€â”€ api/admin/mapping/*.ts (Next.js API proxies)

tests/
â””â”€â”€ test_admin_mapping_approve.py (8 tests)

docs/admin/
â””â”€â”€ STEP_NEXT7_ADMIN_MAPPING_WORKBENCH.md (complete documentation)
```

**DoD Status (NEXT-7-Î´):**
- [x] OPEN UNMAPPED/AMBIGUOUS events queued with deduplication
- [x] Admin approval reflects to coverage_code_alias or coverage_name_map
- [x] All actions logged to admin_audit_log
- [x] Conflicts/invalid codes fail conservatively (no auto-overwrite)
- [x] Backend tests enhanced (7 tests, DB reflection verified, conflict test restored)
- [x] Docker Compose test environment created
- [x] One-command migration script (`./tools/db/apply_migrations_next7.sh`)
- [x] One-command test runner (`./tools/test/run_admin_mapping_tests.sh`)
- [x] DB reflection checks added (coverage_name_map + audit_log verification)
- [x] Execution log documented (docs/admin/STEP_NEXT7_DELTA_SMOKE_LOG.md)
- [ ] Main branch commit + push (NEXT-7-Î´)

**Next Steps (One-Command Execution):**
- Run tests: `./tools/test/run_admin_mapping_tests.sh`
- Or step-by-step:
  1. Start DB: `docker-compose -f docker-compose.test.yml up -d`
  2. Migrate: `./tools/db/apply_migrations_next7.sh`
  3. Test: `python -m pytest tests/test_admin_mapping_approve.py -v`
- Verify: All 7 tests pass (no skip/xfail)
- Cleanup: `docker-compose -f docker-compose.test.yml down`

---

### âœ… STEP NEXT-6: Clarify Panel + Deterministic Compiler + Debug Tab (Complete)
**Commit:** fecf858 | **Date:** 2025-12-26

**Summary:**
- Backend: Deterministic compiler module (rule-based, no LLM)
- Backend: `/compare/compile` endpoint (CompileInput â†’ compiled ProposalCompareRequest)
- Backend: `/compare/clarify` endpoint (clarification detection)
- Frontend: ClarifyPanel component (selection UI for ambiguous queries)
- Frontend: DebugPanel component (compiler debug info, hidden by default)
- Frontend: Test page at `/compare-clarify-test`
- 21 automated tests (100% passing): determinism + endpoint + scenarios
- No LLM dependency verified (mock tests passing)

**Module Structure (Backend):**
```
apps/api/app/compiler/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ version.py (rule version tracking: v1.0.0-next6)
â”œâ”€â”€ rules.py (deterministic domain/keyword mapping)
â”œâ”€â”€ schemas.py (CompileInput/Output, CompilerDebug)
â””â”€â”€ compiler.py (compile_request, detect_clarification_needed)
```

**Component Structure (Frontend):**
```
apps/web/src/
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ clarify/
â”‚   â”‚   â””â”€â”€ ClarifyPanel.tsx  # Selection UI (insurers/surgery/cancer/focus)
â”‚   â””â”€â”€ debug/
â”‚       â””â”€â”€ DebugPanel.tsx    # Debug info (toggle, hidden by default)
â”œâ”€â”€ lib/clarify/
â”‚   â”œâ”€â”€ types.ts              # TypeScript types
â”‚   â””â”€â”€ normalize.ts          # Selection â†’ CompileInput
â””â”€â”€ pages/
    â””â”€â”€ compare-clarify-test.tsx  # Test page (/compare-clarify-test)
```

**Compiler Features:**
- **Deterministic**: Same input â†’ same output (test-verified)
- **No LLM**: Rule-based only (no OpenAI/Anthropic calls)
- **Traceable**: decision_trace logs all applied rules
- **Versioned**: rule_version tracked (v1.0.0-next6)
- **Fast**: <10ms compilation time (no network calls)

**Clarification Triggers:**
1. Insurers < 2
2. Surgery method keywords detected (ë‹¤ë¹ˆì¹˜/ë¡œë´‡/ë³µê°•ê²½)
3. Cancer subtype keywords detected (ì œìë¦¬ì•”/ê²½ê³„ì„±ì¢…ì–‘/ìœ ì‚¬ì•”)
4. Comparison focus unclear (amount/definition/condition)

**Debug Panel Policy:**
- **Default: Hidden** (toggle button to show)
- **Content**: rule_version, selected_slots, decision_trace, warnings, compiled_request JSON
- **Constitutional**: Fact-only, no recommendation/judgment

**Tests** (21/21 passing):
1. Compiler determinism (6 tests)
   - Same input â†’ same output
   - Different inputs â†’ different outputs
   - Rule version tracking
   - Decision trace reproducibility
2. Endpoint tests (10 tests)
   - `/compare/compile` schema validation
   - Options handling (surgery_method, cancer_subtypes, comparison_focus)
   - `/compare/clarify` detection logic
3. No LLM dependency (5 tests)
   - No OpenAI calls
   - No Anthropic calls
   - Fast execution (<100ms)
   - No external API calls
4. E2E scenarios (5 tests)
   - Scenario 1: ë‹¤ë¹ˆì¹˜ ìˆ˜ìˆ ë¹„ (surgery_method selection)
   - Scenario 2: ê²½ê³„ì„±ì¢…ì–‘Â·ì œìë¦¬ì•” (cancer_subtypes selection)
   - Scenario 3: ì•” ì§„ë‹¨ë¹„ (general comparison)
   - Determinism guarantee across scenarios
   - Debug info always present

**Documentation:**
- `docs/ui/STEP_NEXT6_CLARIFY_AND_DEBUG.md` (complete spec)

**Constitutional Compliance:**
- âœ… Fact-only (no recommendation)
- âœ… No inference (rule-based only)
- âœ… Presentation only (selection UI)
- âœ… Deterministic compiler (reproducible)
- âœ… Canonical coverage rule (ì‹ ì •ì› í†µì¼ì½”ë“œ)

### âœ… STEP NEXT-5: ViewModel Assembler + Frontend Renderer (Complete)
**Commit:** 0ee2373 | **Date:** 2025-12-26

**Summary:**
- Backend: ViewModel assembler (ProposalCompareResponse â†’ ViewModel JSON)
- Backend: `/compare/view-model` endpoint with runtime schema validation
- Backend: 15 automated tests (100% passing)
- Frontend: 3-Block ChatGPT-style renderer (React/TypeScript)
- Frontend: 5 components (CompareViewModelRenderer + 4 blocks)
- Frontend: Test page at `/compare-test`
- Evidence reference integrity guaranteed
- Hard-ban phrase detection (0 violations)
- Debug section non-display enforced

**Module Structure (Backend):**
```
apps/api/app/view_model/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ types.py (Pydantic models matching JSON Schema)
â”œâ”€â”€ schema_loader.py (JSON Schema loader + validator)
â””â”€â”€ assembler.py (assembler logic)
```

**Component Structure (Frontend):**
```
apps/web/src/
â”œâ”€â”€ components/compare/
â”‚   â”œâ”€â”€ CompareViewModelRenderer.tsx  # Entry (3-Block layout)
â”‚   â”œâ”€â”€ ChatHeader.tsx                # BLOCK 0: User query
â”‚   â”œâ”€â”€ CoverageSnapshot.tsx          # BLOCK 1: Per-insurer snapshot
â”‚   â”œâ”€â”€ FactTable.tsx                 # BLOCK 2: Comparison table
â”‚   â””â”€â”€ EvidenceAccordion.tsx         # BLOCK 3: Collapsible evidence
â”œâ”€â”€ lib/compare/
â”‚   â””â”€â”€ viewModelTypes.ts             # TypeScript types from JSON Schema
â””â”€â”€ pages/
    â””â”€â”€ compare-test.tsx              # Test page (/compare-test)
```

**Assembler Features:**
- **Conservative status mapping**: No new inference (existing data â†’ StatusCode)
- **Deterministic**: Same input â†’ same output (test-verified)
- **Amount formatting**: ì› â†’ ë§Œì› conversion with thousand separator
- **Evidence ID generation**: `ev_{insurer}_{doc_type}_{index}` (deterministic)
- **Stable sorting**: fact_table rows (insurer/coverage), evidence_panels (insurer/doc_type/id)
- **Ref integrity**: All evidence_ref_id resolve to evidence_panels[].id

**Status Mapping Rules** (Conservative, No Inference):
| Input | Output Status |
|-------|---------------|
| mapping_status=UNMAPPED | UNMAPPED |
| mapping_status=AMBIGUOUS | AMBIGUOUS |
| comparison_result=out_of_universe | OUT_OF_UNIVERSE |
| comparison_result=comparable + MAPPED | OK |
| comparison_result=comparable_with_gaps | MISSING_EVIDENCE (conservative) |
| comparison_result=non_comparable | OK (fact exists) |
| Otherwise | MISSING_EVIDENCE (conservative fallback) |

**Endpoint:**
- URL: `POST /compare/view-model`
- Request: `ProposalCompareRequest` (same as `/compare`)
- Response: ViewModel JSON (schema-validated)
- Validation: Runtime check against `compare_view_model.schema.json` (env-controlled, default ON)
- Flow: `/compare` logic â†’ assemble ViewModel â†’ validate â†’ return JSON

**Tests** (15/15 passing):
1. Schema validation (JSON Schema Draft 2020-12 compliance)
2. Evidence ref_id integrity (all refs resolve)
3. No forbidden phrases (hard-ban enforced)
4. Schema version format (`next4.vX`)
5. Deterministic output (reproducibility)
6. Fact table columns fixed (6 columns, immutable order)
7. Fact table deterministic sort (insurer/coverage ASC)
8. UNMAPPED status mapping
9. OUT_OF_UNIVERSE handling (empty snapshot/rows/panels)
10. Policy evidence added to panels
11. Amount formatting (ì› â†’ ë§Œì›)
12. Debug section optional
13. Canonical coverage codes in debug only
14. Excerpt length constraints (min 25 chars)
15. Insurer codes uppercase (canonical format)

**Golden Samples** (Test Fixtures):
- `sample_comparable_response`: Scenario A (both MAPPED, normal flow)
- `sample_unmapped_response`: Scenario B (UNMAPPED coverage)
- `sample_out_of_universe_response`: OUT_OF_UNIVERSE edge case
- `sample_with_policy_evidence_response`: Scenario C (policy evidence)

**Schema Updates:**
- Allow `null` for optional fields: `bbox`, `source_meta`, `debug.*`
- Rationale: Pydantic emits `null` for unset optional fields

**Frontend Implementation:**
- **BLOCK 0: ChatHeader**: Displays user_query + normalized_query (no internal codes)
- **BLOCK 1: CoverageSnapshot**: Shows comparison_basis + per-insurer headline amounts/status
- **BLOCK 2: FactTable**: Fixed 6-column layout (immutable order), no frontend sorting
  - Columns: ë³´í—˜ì‚¬, ë‹´ë³´ëª…(ì •ê·œí™”), ë³´ì¥ê¸ˆì•¡, ì§€ê¸‰ ì¡°ê±´ ìš”ì•½, ë³´í—˜ê¸°ê°„, ë¹„ê³ 
  - Payout conditions: bullet list (Korean label + value_text, no interpretation)
- **BLOCK 3: EvidenceAccordion**: Collapsible per-insurer groups (doc_type, page, excerpt as-is)
- **Test Page**: `/compare-test` (example selector + live API test button)
- **Edge Cases**: Handles UNMAPPED/OUT_OF_UNIVERSE/empty evidence without crash

**Constitutional Compliance:**
- âœ… Backend: Fact-only (status from existing data, no new inference)
- âœ… Backend: No Recommendation (0 forbidden phrases, test-enforced)
- âœ… Backend: Presentation Only (pure mapping/formatting, no business logic)
- âœ… Frontend: Fact-only (display ViewModel as-is, no modification)
- âœ… Frontend: No Recommendation (zero "better/worse/same/different" phrases)
- âœ… Frontend: Presentation Only (no sorting/filtering/scoring)
- âœ… Frontend: Debug Non-UI (debug section completely hidden)
- âœ… Canonical Coverage Rule: Internal codes in debug, UI uses normalized names
- âœ… Coverage Universe Lock: OUT_OF_UNIVERSE for non-proposal
- âœ… Evidence Rule: All amounts have evidence_ref_id
- âœ… Deterministic: Test-verified reproducibility

**DoD Achievement:**
- âœ… Backend: `/compare/view-model` endpoint schema-compliant
- âœ… Backend: Assembler validates against JSON Schema
- âœ… Backend: Hard-ban test passing (0 violations)
- âœ… Backend: Evidence ref_id integrity passing
- âœ… Backend: 15/15 tests passing
- âœ… Frontend: CompareViewModelRenderer renders schema-compliant ViewModel
- âœ… Frontend: 3-Block structure implemented (Header, Snapshot, FactTable, Evidence)
- âœ… Frontend: Debug section non-display enforced
- âœ… Frontend: Build passes (type-safe)
- âœ… Frontend: Test page functional with example data
- âœ… Documentation complete (`STEP_NEXT5_ADAPTER_AND_RENDERER.md` v2.0.0)

**Key Principle:**
- **Assembler = Adapter = Presentation Layer = No Inference**
- **Status from existing data only (conservative fallback to MISSING_EVIDENCE)**
- **Same input â†’ same output (deterministic, test-verified)**

---

### âœ… STEP NEXT-4: ViewModel JSON Schema Contract
**Commit:** e19f3f1 | **Date:** 2025-12-26

**Summary:**
- JSON Schema Draft 2020-12 for UI ViewModel (presentation layer contract)
- 5 validated examples (cancer diagnosis, borderline tumor, robotic surgery, UNMAPPED, missing evidence)
- 16 automated tests enforcing constitutional compliance
- Forbidden phrase detection (hard ban on recommendations/judgments)
- Reference integrity validation (evidence_ref_id â†’ evidence_panels[].id)

**Deliverables:**
1. `docs/ui/STEP_NEXT4_VIEWMODEL_SCHEMA.md` (19-section specification)
2. `docs/ui/compare_view_model.schema.json` (JSON Schema Draft 2020-12)
3. `docs/ui/compare_view_model.examples.json` (5 examples)
4. `tests/test_ui_viewmodel_schema.py` (16 validation tests)

**Schema Structure:**
```json
{
  "schema_version": "next4.v1",
  "generated_at": "ISO8601",
  "header": {...},          // BLOCK 0: User Query
  "snapshot": {...},        // BLOCK 1: Coverage Snapshot
  "fact_table": {...},      // BLOCK 2: Fact Table
  "evidence_panels": [...], // BLOCK 3: Evidence Accordion
  "debug": {...}            // Non-UI: Reproducibility
}
```

**Top-Level Fields:**
- `schema_version`: "next4.v1" (version strategy defined)
- `generated_at`: ISO 8601 timestamp
- `header`: User query (original + normalized)
- `snapshot`: Comparison basis + per-insurer headline amounts
- `fact_table`: Fixed 6 columns (ë³´í—˜ì‚¬/ë‹´ë³´ëª…/ë³´ì¥ê¸ˆì•¡/ì§€ê¸‰ì¡°ê±´/ë³´í—˜ê¸°ê°„/ë¹„ê³ )
- `evidence_panels`: Document type + page + excerpt (25-400 chars)
- `debug`: Coverage codes, retrieval params (optional, MUST NOT display in UI)

**Enum Definitions:**
- Insurers: `SAMSUNG, HANWHA, LOTTE, MERITZ, KB, HYUNDAI, HEUNGKUK, DB`
- Status: `OK, MISSING_EVIDENCE, UNMAPPED, AMBIGUOUS, OUT_OF_UNIVERSE`
- Doc Types: `ê°€ì…ì„¤ê³„ì„œ, ì•½ê´€, ìƒí’ˆìš”ì•½ì„œ, ì‚¬ì—…ë°©ë²•ì„œ`
- Slot Keys: `waiting_period, payment_frequency, diagnosis_definition, method_condition, exclusion_scope, payout_limit, disease_scope`

**Validation Tests (16 total, all passing):**
1. Schema is valid JSON Schema Draft 2020-12
2. All examples validate against schema
3. No forbidden phrases in examples (hard ban enforced)
4. Required top-level fields present
5. Schema version format compliance
6. Insurer enum compliance (snapshot + fact_table + evidence_panels)
7. Fact table columns fixed and ordered
8. Evidence reference integrity (all ref_ids resolve)
9. Slot key enum compliance
10. Status enum compliance (snapshot + fact_table)
11. Doc type enum compliance
12. Excerpt length constraints (25-400 chars)
13. Debug section optional
14. Constitutional compliance matrix
15. Minimum example count (â‰¥4)
16. Required scenario coverage (cancer, borderline, robotic, unmapped)

**Example Scenarios:**
1. **Standard Cancer Diagnosis** (ì•” ì§„ë‹¨ë¹„): 2 insurers, normal flow
2. **Borderline Tumor** (ê²½ê³„ì„±ì¢…ì–‘): Definition-based, disease_scope slot
3. **Robotic Surgery** (ë‹¤ë¹ˆì¹˜ ìˆ˜ìˆ ë¹„): Method-based, method_condition slot
4. **UNMAPPED Coverage** (ì‹ ì¢…ìˆ˜ìˆ ë¹„): Missing canonical code, edge case
5. **Missing Evidence** (ì‹¬ê·¼ê²½ìƒ‰ì¦): Incomplete slot data, policy review needed

**Constitutional Compliance:**
- âœ… Fact-only: All amounts require evidence_ref_id
- âœ… No Recommendation: Forbidden phrases validated (hard ban)
- âœ… Presentation Only: No logic fields (score/rank/judgment)
- âœ… Canonical Coverage: coverage_title_normalized from coverage_standard
- âœ… Coverage Universe Lock: OUT_OF_UNIVERSE status for non-proposal coverages
- âœ… Evidence Rule: evidence_panels required, excerpt minLength=25
- âœ… Deterministic Output: Same input â†’ same JSON structure

**Forbidden Expressions (Hard Ban, Test-Enforced):**
- âŒ "ë” ì¢‹ë‹¤", "ìœ ë¦¬í•˜ë‹¤", "ë¶ˆë¦¬í•˜ë‹¤"
- âŒ "ì¶”ì²œ", "ê¶Œì¥", "ì„ íƒí•˜ì„¸ìš”"
- âŒ "ìš°ìˆ˜", "ë›°ì–´ë‚¨", "ìµœì„ "
- âŒ "ë™ì¼í•¨", "ì°¨ì´ ì—†ìŒ"
- âŒ "ì‚¬ì‹¤ìƒ ê°™ì€ ë‹´ë³´", "ìœ ì‚¬í•œ ë‹´ë³´"
- âŒ "ì¢…í•©ì ìœ¼ë¡œ", "ê²°ë¡ ì ìœ¼ë¡œ"

**Frontend/Backend Contract:**
- Backend: Generates JSON matching this schema
- Frontend: Renders JSON (no processing, display only)
- `debug` section: MUST NOT be displayed in UI
- Column order: Immutable (frontend cannot reorder)
- Reference integrity: All `evidence_ref_id` must resolve

**Version Strategy:**
- `next4.vX`: Breaking changes (add/remove required fields)
- `next4.vX.Y`: Non-breaking (add optional fields)
- Backwards compatibility: Frontend handles unknown optional fields

**DoD Achievement:**
- âœ… `compare_view_model.schema.json` exists (Draft 2020-12)
- âœ… 5 examples validate against schema
- âœ… Forbidden phrase test implemented (detects 15+ patterns)
- âœ… Reference integrity test implemented
- âœ… `debug` excluded from UI rendering contract
- âœ… 16/16 tests passing
- âœ… Constitutional compliance verified

**Next Steps:**
1. Backend API implementation: `/api/compare` ViewModel assembly
2. Frontend component development: 3-Block renderer (React/Vue)
3. Integration with STEP 3.x PRIME comparison results

**Key Principle:**
- **ViewModel = Presentation Layer Contract = Fact-Only = No Judgment**
- **Schema enforces constitutional compliance (automated validation)**
- **Same input â†’ same output structure (deterministic)**

---

### âœ… STEP NEXT-3: UI Layout Specification (ChatGPT-Style MVP)
**Commit:** 1bacd1e | **Date:** 2025-12-26

**Summary:**
- Fixed 3-Block ChatGPT-style UI layout specification for insurance comparison MVP
- Fact-only presentation layer (absolutely no inference, judgment, or recommendations)
- Constitutional compliance enforced (prohibited phrases, canonical coverage rule)
- 8 concrete examples covering standard/edge/special cases

**3-Block Structure (Fixed):**
```
[BLOCK 0] User Query (Chat Header)
[BLOCK 1] Coverage Snapshot
[BLOCK 2] Fact Table (Coverage Comparison)
[BLOCK 3] Evidence Panels (Accordion)
```

**Constitutional Principles (Hard Enforced):**
1. **Fact-only**: All data from document evidence, no inference
2. **No Recommendation**: Absolutely no "better/recommended" language
3. **Presentation Layer Only**: No business logic in UI
4. **Canonical Coverage Rule**: Normalized coverage names in tables

**Block Definitions:**

**BLOCK 0 (User Query):**
- User question displayed exactly as asked (1 line)
- No rephrasing, no internal processing info

**BLOCK 1 (Coverage Snapshot):**
- Normalized coverage name (canonical)
- Insurer list + amounts
- NO comparative judgments ("ë™ì¼í•¨", "ì°¨ì´ ì—†ìŒ" prohibited)

**BLOCK 2 (Fact Table):**
| ë³´í—˜ì‚¬ | ë‹´ë³´ëª…(ì •ê·œí™”) | ë³´ì¥ê¸ˆì•¡ | ì§€ê¸‰ ì¡°ê±´ ìš”ì•½ | ë³´í—˜ê¸°ê°„ | ë¹„ê³  |

- Slot-based conditions only (waiting_period, payment_frequency, etc.)
- NO sentence rewriting or interpretation
- UNMAPPED/AMBIGUOUS tags in ë¹„ê³  column

**BLOCK 3 (Evidence Panels):**
- Collapsible per-insurer accordion
- Document type + page + original text span (max 200 chars)
- NO rewriting, NO summarization, NO interpretation

**Special Comparison Cases:**

1. **ê²½ê³„ì„±ì¢…ì–‘/ì œìë¦¬ì•”/ìœ ì‚¬ì•”** (Definition-based):
   | ë³´í—˜ì‚¬ | ì§ˆë³‘ ìœ í˜• | ë³´ì¥ ì—¬ë¶€ | ì§€ê¸‰ ë¹„ìœ¨ | ì •ì˜ ê·¼ê±° |

2. **ë‹¤ë¹ˆì¹˜/ë¡œë´‡ ìˆ˜ìˆ ë¹„** (Method-based):
   | ë³´í—˜ì‚¬ | ìˆ˜ìˆ  ë°©ì‹ | ë³´ì¥ ë‹´ë³´ | ê¸ˆì•¡ | ì œí•œ ì¡°ê±´ |

**Edge Cases Handled:**
- UNMAPPED coverage: Tag + "(UNMAPPED)" in ë¹„ê³ 
- AMBIGUOUS mapping: Tag + "(AMBIGUOUS - ìˆ˜ë™ ë§¤í•‘ í•„ìš”)"
- Out of Universe: Separate message (no 3-Block rendering)
- Missing evidence: "(ê·¼ê±° ì—†ìŒ)" in evidence panel

**Prohibited Expressions (Hard Ban):**
- âŒ "ë” ì¢‹ë‹¤", "ìœ ë¦¬í•˜ë‹¤", "ë¶ˆë¦¬í•˜ë‹¤"
- âŒ "ì¶”ì²œ", "ê¶Œì¥"
- âŒ "ìš°ìˆ˜", "ë›°ì–´ë‚¨"
- âŒ "ë™ì¼í•¨", "ì°¨ì´ ì—†ìŒ"
- âŒ "Aì‚¬ê°€ Bì‚¬ë³´ë‹¤..."
- âŒ "ì¢…í•©ì ìœ¼ë¡œ ë³¼ ë•Œ..."

**Allowed Expressions (Fact-based):**
- âœ… "ëŒ€ê¸°ê¸°ê°„: 90ì¼"
- âœ… "ì§€ê¸‰ íšŸìˆ˜: ìµœì´ˆ 1íšŒ"
- âœ… "ì œì™¸ ë²”ìœ„: ìœ ì‚¬ì•”, ê°‘ìƒì„ ì•”"
- âœ… "(ì•½ê´€ í™•ì¸ í•„ìš”)"
- âœ… "(UNMAPPED)", "(AMBIGUOUS)"

**Generated Files:**
- `docs/ui/STEP_NEXT3_UI_LAYOUT.md` (full specification with 11 sections)
- `docs/ui/STEP_NEXT3_UI_EXAMPLES.md` (8 concrete examples)

**Examples (8 scenarios):**
1. Standard cancer diagnosis (ì•” ì§„ë‹¨ë¹„)
2. Borderline tumor (ê²½ê³„ì„±ì¢…ì–‘) - definition-based table
3. Robotic surgery (ë‹¤ë¹ˆì¹˜ ìˆ˜ìˆ ë¹„) - method-based table
4. UNMAPPED coverage (edge case)
5. Out of Universe (edge case)
6. AMBIGUOUS mapping (edge case)
7. Missing evidence (slot unknown)
8. Multiple coverage variants (same canonical)

**Data Flow:**
```
Backend (View Model JSON)
  â†“
Frontend (3-Block Renderer)
  â†“
User Display
```

**Frontend/Backend Separation:**
- Backend: Comparison logic, slot extraction, evidence retrieval, View Model assembly
- Frontend: Rendering only, accordion interaction, NO data processing

**Validation Checklist:**
- âœ… No judgment/recommendation phrases
- âœ… All amounts have evidence
- âœ… No rewriting of original text
- âœ… Canonical coverage names used
- âœ… Prohibited elements (opinion, icon, color) absent
- âœ… 3-Block structure strictly followed

**Constitutional Compliance:**
- âœ… Coverage Universe Lock: BLOCK 2 uses normalized names
- âœ… Document Priority: Evidence panels show doc_type hierarchy
- âœ… Deterministic Output: Same input â†’ same structure
- âœ… No LLM Inference: All text from evidence or slots
- âœ… Presentation Layer Only: Zero business logic in UI

**DoD Achievement:**
- âœ… Fixed 3-Block structure defined
- âœ… 11-section specification document
- âœ… 8 concrete examples (standard + edge + special)
- âœ… Prohibited phrases list (hard ban)
- âœ… Frontend-ready (no ambiguity)
- âœ… Constitutional compliance matrix
- âœ… Ready for STEP NEXT-4 (JSON Schema definition)

**Next Steps:**
1. STEP NEXT-4: JSON Schema Definition (formalize View Model)
2. Backend API Implementation (/api/compare View Model assembly)
3. Frontend Component Development (React/Vue 3-block renderer)

**Key Principle:**
- **UI = View Model = Presentation Layer ONLY**
- **No inference, no judgment, no recommendation, ever.**
- **Same input â†’ same output structure guaranteed.**

---

### âœ… STEP 4.2: Customer Response Enhancement (Structural UNMAPPED Handling)
**Commit:** 00b5c70 | **Date:** 2025-12-26

**Summary:**
- Enhanced STEP 4.0 customer responses with Structural Notice Block
- Made structural UNMAPPED understandable (not system failures)
- Provided honest explanations without inference or recommendations
- **No state changes**: PRIME results preserved, presentation only

**Key Achievement:**
- **Transformed "ë¹„êµ ë¶ˆê°€" â†’ "í™•ì¸ í•„ìš”"**
- Structural UNMAPPED = designed limitation, not system incompetence

**Message Templates (Fixed):**

| Type | Customer Message |
|------|------------------|
| **S1_SPLIT** | "ì„¸ë¶€ í•­ëª©ì´ ë‚˜ë‰˜ì–´ ê¸°ì¬ë˜ì–´ ìˆì–´ ë‹¨ìˆœ ë¹„êµí•˜ê¸° ì–´ë µìŠµë‹ˆë‹¤" |
| **S2_COMPOSITE** | "ì—¬ëŸ¬ ë³´ì¥ ë‚´ìš©ì„ ë¬¶ì–´ ì œê³µë©ë‹ˆë‹¤. ë³´ì¥ ë²”ìœ„ê°€ ë³´í—˜ì‚¬ë§ˆë‹¤ ë‹¤ë¦…ë‹ˆë‹¤" |
| **S3_POLICY_ONLY** | "ìš”ì•½ ì •ë³´ë§Œìœ¼ë¡œëŠ” ë³´ì¥ ë²”ìœ„ í™•ì •ì´ ì–´ë ¤ì›Œ ì•½ê´€ í™•ì¸ í•„ìš”í•©ë‹ˆë‹¤" |

**Next Action Options (Non-Recommendations):**
```
â–¡ íŠ¹ì • í•˜ìœ„ ë‹´ë³´ë§Œ ì„ íƒí•´ì„œ ë³´ê¸°
â–¡ ê°€ì…ì„¤ê³„ì„œ ìƒì„¸ ë³´ì¥ ë‚´ìš© í™•ì¸
â–¡ ì•½ê´€ ê¸°ì¤€ìœ¼ë¡œ ë¹„êµ ìš”ì²­
```

**Display Conditions:**
- PRIME state = `in_universe_with_gaps` OR
- mapping_status = `UNMAPPED` OR
- structural_type âˆˆ {S1_SPLIT, S2_COMPOSITE, S3_POLICY_ONLY}

**Response Structure (4 sections):**
1. Summary Header (STEP 4.0)
2. Comparison Table (STEP 4.0)
3. Insurer Explanation Blocks (STEP 4.0)
4. **Structural Notice Block** (STEP 4.2 NEW) â† Key Addition

**Generated Files:**
- `scripts/step42_customer_response_enhancer.py`
- `docs/customer_response_examples_step42.md`

**Constitutional Compliance:**
- âœ… PRIME results IMMUTABLE (STEP 3.11 untouched)
- âœ… Explanations IMMUTABLE (STEP 3.12 untouched)
- âœ… Pure presentation layer (no state changes)
- âœ… No forbidden phrases ("ì‚¬ì‹¤ìƒ ê°™ë‹¤", "ì¶”ì²œí•©ë‹ˆë‹¤" etc)
- âœ… No inference/recommendations
- âœ… No shinjeongwon code mentions in customer output
- âœ… Deterministic (same input â†’ same output)

**Forbidden Expressions (Hard Ban):**
- âŒ "ì‚¬ì‹¤ìƒ ê°™ì€ ë‹´ë³´"
- âŒ "ìœ ì‚¬í•œ ë‹´ë³´"
- âŒ "ì¼ë°˜ì ìœ¼ë¡œ/ë³´í†µì€"
- âŒ "ì¶”ì²œí•©ë‹ˆë‹¤/ì„ íƒí•˜ì„¸ìš”"
- âŒ "ë” ë‚˜ì€/ìœ ë¦¬í•œ"
- âŒ "í†µí•©í•˜ë©´/ê±°ì˜ ë™ì¼"

**Allowed Expressions (Fact-based Only):**
- âœ… "ì„¸ë¶€ í•­ëª©ì´ ë‚˜ë‰˜ì–´ ìˆìŠµë‹ˆë‹¤"
- âœ… "ì—¬ëŸ¬ ë³´ì¥ì„ ë¬¶ì–´ ì œê³µí•©ë‹ˆë‹¤"
- âœ… "ë³´ì¥ ë²”ìœ„ê°€ ë‹¤ë¦…ë‹ˆë‹¤"
- âœ… "ìš”ì•½í‘œ ê¸°ì¤€ì…ë‹ˆë‹¤"
- âœ… "í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤"

**DoD Achievement:**
- âœ… 100% of structural UNMAPPED cases show Structural Notice
- âœ… Zero forbidden phrases in customer output
- âœ… Zero PRIME state/mapping result changes
- âœ… Deterministic output (pure function)
- âœ… "System incompetence" perception eliminated

**Customer Perception Shift:**
- **Before**: "ì™œ ë¹„êµê°€ ì•ˆë¼? ì‹œìŠ¤í…œì´ ì´ê²ƒë„ ëª»í•´?"
- **After**: "ì•„, ë‹´ë³´ êµ¬ì„±ì´ ë‹¤ë¥´êµ¬ë‚˜. ìƒì„¸í•˜ê²Œ ë³¼ ìˆ˜ ìˆë„¤."

**Integration:**
```python
# STEP 4.0 â†’ STEP 4.2 enhancement
enhanced = enhance_customer_response(base_response, comparison_results)

# No structural issues: enhanced == base (pass-through)
# Structural issues exist: enhanced = base + notice_block
```

---

### âœ… STEP 3.10-Î¸: Structural UNMAPPED Strategy (C3/C4/C7 Processing)
**Commit:** 9160027 | **Date:** 2025-12-26

**Summary:**
- Identified and classified 10 structural UNMAPPED cases (out of 19 total UNMAPPED)
- All structural cases assigned S1/S2/S3 types + NextActions
- Generated backlog for future detailed table / policy layer work
- **No state changes**: PRIME results preserved, no UNMAPPED â†’ MAPPED conversion

**Structural Type Distribution:**

| Type | Count | Percentage | Description |
|------|-------|------------|-------------|
| **S1_SPLIT** | 5 | 50.0% | Subcategory split (C3) |
| **S2_COMPOSITE** | 5 | 50.0% | Composite coverage (C4) |
| **S3_POLICY_ONLY** | 0 | 0.0% | Policy-level only (C7) |
| **TOTAL** | 10 | 100.0% | |

**Per-Insurer Breakdown:**

| Insurer | Total | S1 | S2 | S3 |
|---------|-------|----|----|-----|
| HANWHA | 7 | 2 | 5 | 0 |
| KB | 2 | 2 | 0 | 0 |
| SAMSUNG | 1 | 1 | 0 | 0 |

**Group Key Success:**
- Generated: 10/10 (100.0%)
- All structural cases successfully labeled

**NextAction Distribution:**

| Action | Count | Description |
|--------|-------|-------------|
| A1_CREATE_GROUP_KEY | 10 | Labeling for comparison grouping |
| A2_REQUIRE_USER_DISAMBIGUATION | 10 | User query refinement needed |
| A3_DEFER_TO_DETAIL_TABLE | 5 | Detailed table parser (STEP 4.x) |
| A4_DEFER_TO_POLICY_LAYER | 0 | Policy document analysis |
| A5_MANUAL_REVIEW_QUEUE | 0 | Human structure definition |

**Remaining UNMAPPED Analysis:**
- Total UNMAPPED: 19 (from Î·-2)
- Structural (C3/C4/C7): 10 (52.6%) - **processed in Î¸**
- Non-structural: 9 (47.4%) - **true gaps / insurer-specific**

**Generated Files:**
- `data/step310_mapping/structural_unmapped/STRUCTURAL_UNMAPPED_CASES.csv`
- `data/step310_mapping/structural_unmapped/STRUCTURAL_UNMAPPED_SUMMARY.md`
- `data/step310_mapping/structural_unmapped/STRUCTURAL_BACKLOG.md`

**Script:**
- `scripts/step310_theta_structural_unmapped.py`

**Backlog for Future Steps:**
1. **High Priority**: A3 - Detailed table parser (enables S2_COMPOSITE resolution)
2. **Medium Priority**: A2 - Query refinement (improves UX for S1_SPLIT cases)
3. **Medium Priority**: A4 - Policy layer (for S3_POLICY_ONLY if any emerge)
4. **Low Priority**: A5 - Manual review (case-by-case)

**Constitutional Compliance:**
- âœ… No UNMAPPED â†’ MAPPED conversion
- âœ… No shinjeongwon code inference
- âœ… No coverage consolidation
- âœ… No similarity/embedding/LLM
- âœ… PRIME state unchanged
- âœ… Backlog only (no actual policy reading)
- âœ… Group keys = labels only (not integration)

**DoD Achievement:**
- âœ… All C3/C4/C7 cases extracted from eta2 UNMAPPED
- âœ… All cases assigned structural_type (S1/S2/S3)
- âœ… All cases assigned next_actions (100%)
- âœ… STRUCTURAL_UNMAPPED_CASES.csv + 2 MD reports generated
- âœ… PRIME results preserved (non-destructive)
- âœ… Reproducibility guaranteed (deterministic classification)

**Key Insight:**
- Structural UNMAPPED (10/19) require **system enhancement**, not Excel additions
- Non-structural UNMAPPED (9/19) are **true coverage gaps** or insurer-specific unique products
- No further UNMAPPEDâ†’MAPPED conversions possible without detailed table parser

---

### âœ… STEP 3.10-Î·-2: Forced Remapping with Enhanced Excel (Reproducibility Locked)
**Commit:** 2769542 | **Date:** 2025-12-26

**Summary:**
- Forced re-execution of STEP 3.10-2 mapping logic
- Used enhanced Excel (`ë‹´ë³´ëª…mappingìë£Œ__inscd_patched_plus.xlsx`) as input
- Generated new mapping results with __eta2 suffix
- **Proved Î· enhancement effectiveness with numbers**

**Results (Numbers Only):**

| Status | Î¶ (Baseline) | Î·-2 (Enhanced) | Change |
|--------|--------------|----------------|--------|
| **MAPPED** | 259 (77.54%) | **315 (94.31%)** | **+56** |
| **UNMAPPED** | 75 (22.46%) | **19 (5.69%)** | **-56** |
| **AMBIGUOUS** | 0 (0.00%) | 0 (0.00%) | 0 |
| **TOTAL** | 334 | 334 | 0 |

**Key Metrics:**
- MAPPED improvement: **+56 entries** (116.7% of 48 Excel additions)
- UNMAPPED reduction: **-56 entries** (74.7% reduction)
- Final MAPPED ratio: **94.31%** (exceeds 85% target âœ…)
- DB & LOTTE: **100% MAPPED** ğŸ‰

**Per-Insurer Results:**
| Insurer | MAPPED | UNMAPPED | Ratio |
|---------|--------|----------|-------|
| DB | 62 | 0 | 100.0% âœ… |
| LOTTE | 70 | 0 | 100.0% âœ… |
| SAMSUNG | 40 | 1 | 97.6% |
| MERITZ | 32 | 2 | 94.1% |
| HYUNDAI | 25 | 2 | 92.6% |
| HEUNGKUK | 21 | 2 | 91.3% |
| KB | 35 | 5 | 87.5% |
| HANWHA | 30 | 7 | 81.1% |

**Generated Files:**
- New mapping CSV: `proposal_coverage_mapping_insurer_filtered__eta2.csv`
- Comparison report: `mapping_report_insurer_filtered__eta2.md`
- Reproducibility doc: `EXCEL_REPRODUCE_INSTRUCTIONS.md`

**Script:**
- `scripts/step310_eta2_forced_remapping.py`

**Reproducibility Lock:**
- âœ… Enhanced Excel regeneration path documented
- âœ… Complete reproduction instructions provided
- âœ… Same input â†’ same output guaranteed

**Constitutional Compliance:**
- âœ… Mapping logic unchanged (STEP 3.10-2 as-is)
- âœ… Enhanced Excel as sole input
- âœ… No rule modifications
- âœ… Deterministic execution
- âœ… Numbers-only proof (no claims without data)

**DoD Achievement:**
- âœ… Enhanced Excel-based remapping complete
- âœ… Before/after metrics reported (numbers only)
- âœ… Excel reproducibility path fixed
- âœ… Reproducibility guaranteed
- âœ… UNMAPPED reduction proven (+56 MAPPED)
- âœ… 94.31% MAPPED ratio achieved (target: â‰¥85%)

**Effectiveness Proof:**
- 48 Excel rows added â†’ 56 new MAPPED entries
- Conversion rate: 116.7% (some rows matched multiple proposals)
- Zero AMBIGUOUS maintained throughout

---

### âœ… STEP 3.10-Î·: Excel Enhancement - UNMAPPED Backlog Processing
**Commit:** cde40d8 | **Date:** 2025-12-26

**Summary:**
- Processed UNMAPPED backlog from STEP 3.10-Î³
- Added 48 new mapping rows to Excel (qualified ADD targets)
- Deferred 19 structural cases to STEP 3.10-Î¸
- Generated enhanced Excel: `ë‹´ë³´ëª…mappingìë£Œ__inscd_patched_plus.xlsx`

**Processing Rules:**
- âœ… ADD_EXCEL_ROW: immediate processing (C1/C2/C6 causes only)
- âœ… ADD_EXCEL_ROW_WITH_NOTE: with annotation
- âŒ STRUCTURAL cases deferred (C3/C4/C7)

**Enhancement Results:**
- Total backlog items: 67
- Processed (added): 48 (71.6%)
- Deferred: 19 (28.4%)
- Processing rate: 71.6%

**Current Mapping Status:**
- MAPPED: 259 (77.54%)
- UNMAPPED: 75 (22.46%)
- AMBIGUOUS: 0 (0.00%) âœ…

**Per-Insurer Additions:**
| Insurer | Added Rows |
|---------|------------|
| N01 (SAMSUNG) | 8 |
| N02 (HANWHA) | 2 |
| N03 (LOTTE) | 7 |
| N04 (MERITZ) | 11 |
| N05 (KB) | 7 |
| N06 (HYUNDAI) | 7 |
| N07 (HEUNGKUK) | 3 |
| N08 (DB) | 3 |

**Generated Files:**
- `data/ë‹´ë³´ëª…mappingìë£Œ__inscd_patched_plus.xlsx` (enhanced Excel)
- `data/step310_mapping/excel_enhancement/ENHANCEMENT_LOG.csv`
- `STEP310_ETA_EXCEL_ENHANCEMENT_REPORT.md`
- `STEP310_ETA_FINAL_METRICS_REPORT.md`

**Scripts:**
- `scripts/step310_eta_excel_enhancement.py`
- `scripts/step310_eta_simple_metrics.py`

**Constitution Compliance:**
- âœ… Single Source of Truth: Excel remains canonical mapping authority
- âœ… No LLM Inference: All mappings deterministic (Excel lookup only)
- âœ… Coverage Universe Lock: All proposals remain in universe
- âœ… Evidence Rule: All additions traceable to backlog analysis
- âŒ No coverage code inference
- âŒ No structural assumptions

**DoD Achievement:**
- âœ… ADD-qualified backlog 100% processed (48/48)
- âœ… STRUCTURAL cases 0% processed (deferred as intended: 19/19)
- âœ… Enhanced Excel generated
- âœ… Enhancement logs generated
- âš ï¸ MAPPED ratio 77.54% < 85% target (expected - full pipeline re-run needed)
- âœ… AMBIGUOUS = 0 maintained
- âœ… Git commit complete (cde40d8)

**Next Steps:**
1. STEP 3.10-Î¸: Handle 19 deferred structural cases
2. Full pipeline re-run with enhanced Excel to measure actual MAPPED improvement
3. Admin UI for any remaining manual resolutions

---

### âœ… STEP 3.10-Î¶: ins_cd Patched Excel + Re-run Complete
**Commits:** 2cecda1, efa43b2 | **Date:** 2025-12-26

**Summary:**
- ins_cd ìë™ ì •í•©í™” íŒ¨ì¹˜ë³¸ Excel ìƒì„± (ë¹„íŒŒê´´)
- STEP 3.10-2/Î²/Î³ íŒ¨ì¹˜ë³¸ ê¸°ì¤€ ì¬ì‹¤í–‰
- I3_MISMATCH_PIPELINE_VS_EXCEL: 6 â†’ 0 âœ…
- AMBIGUOUS mappings: 129 â†’ 0 âœ…

**Patch Results:**
- Original Excel preserved: `data/ë‹´ë³´ëª…mappingìë£Œ.xlsx` (read-only)
- Patched Excel generated: `data/ë‹´ë³´ëª…mappingìë£Œ__inscd_patched.xlsx`
- Total affected rows: 194/264 (73.5%)
- ins_cd corrections: 6 insurers (DB, KB, ë©”ë¦¬ì¸ , ì‚¼ì„±, í˜„ëŒ€, í¥êµ­)

**Validation:**
- âœ… ins_cd-only changes verified
- âœ… ins_cd uniqueness per insurer verified
- âœ… I3_MISMATCH_PIPELINE_VS_EXCEL = 0
- âœ… Row count preserved (264 rows)

**Re-run Results:**
1. **STEP 3.10-2** (Insurer-Filtered Mapping):
   - MAPPED: 259 (77.5%)
   - AMBIGUOUS: 0 (0.0%) â† 129 â†’ 0 (100% reduction)
   - UNMAPPED: 75 (22.5%)

2. **STEP 3.10-Î²** (UNMAPPED Cause-Effect):
   - Total UNMAPPED analyzed: 75
   - Cause-effect classifications complete

3. **STEP 3.10-Î³** (Excel Backlog):
   - Unique backlog items: 67
   - Per-insurer backlog CSVs generated

**Generated Files:**
- `data/ë‹´ë³´ëª…mappingìë£Œ__inscd_patched.xlsx`
- `data/step310_mapping/ins_cd_patch/PATCH_LOG.csv`
- `data/step310_mapping/ins_cd_patch/PATCH_SUMMARY.md`
- `data/step310_mapping/ins_cd_patch/VERIFICATION_REPORT.md`
- All STEP 3.10-2/Î²/Î³ reports regenerated

**Scripts:**
- `scripts/step310_zeta_patch_inscd.py`
- `scripts/step310_zeta_verify.py`
- `scripts/step310_2_insurer_filtered_mapping.py` (updated)
- `scripts/step310_beta_unmapped_analysis.py` (updated)

**Constitution Compliance:**
- âœ… Original Excel preserved (non-destructive)
- âœ… ins_cd-only changes (deterministic)
- âœ… Pipeline canonical ins_cd as ground truth
- âœ… Verification script confirms I3 = 0
- âŒ No coverage code inference
- âŒ No mapping logic changes

**DoD Achievement:**
- âœ… Patched Excel generated
- âœ… Patch logs generated
- âœ… I3 mismatch = 0 achieved
- âœ… STEP 3.10-2/Î²/Î³ re-run complete
- âœ… Git commits complete
- âœ… STATUS.md updated

---

### âœ… STEP 3.10-Îµ: ins_cd Consistency Audit
**Commit:** 9b08c86 | **Date:** 2025-12-25

**Summary:**
- ì „ ë³´í—˜ì‚¬ ins_cd ì •í•©ì„± ìë™ ê°ì‚¬ (3ì êµì°¨ê²€ì¦)
- Excel/Pipeline/Proposal ê°„ ins_cd ë¶ˆì¼ì¹˜ ê°ì§€
- 6/8 ë³´í—˜ì‚¬ì—ì„œ mismatch ë°œê²¬ (75% ë¶ˆì¼ì¹˜ìœ¨)
- ê°ì‚¬ ë¦¬í¬íŠ¸ë§Œ ìƒì„± (ìˆ˜ì • ì—†ìŒ)

**Purpose:**
- Cross-validate ins_cd consistency across Excel/Pipeline/Proposal
- Detect mismatches, collisions, missing mappings
- Generate audit reports (NO fixes)

**3-Way Cross-Validation:**
1. **Excel**: ë‹´ë³´ëª…mappingìë£Œ.xlsx (ë³´í—˜ì‚¬ëª… â†’ ins_cd)
2. **Pipeline**: INSURER_NAMES registry (INSURER â†’ ins_cd)
3. **Proposal**: ALL_INSURERS_coverage_universe.csv (insurer existence)

**Audit Results:**
- Total insurers audited: 8
- Insurers OK: 2 (HANWHA, LOTTE)
- Insurers with issues: 6 (75%)

**Issue Breakdown:**
- **I3_MISMATCH_PIPELINE_VS_EXCEL**: 6 cases
  - DB: Pipeline N08 â‰  Excel N13
  - HEUNGKUK: Pipeline N07 â‰  Excel N05
  - HYUNDAI: Pipeline N06 â‰  Excel N09
  - KB: Pipeline N05 â‰  Excel N10
  - MERITZ: Pipeline N04 â‰  Excel N01
  - SAMSUNG: Pipeline N01 â‰  Excel N08

**Recommended Fix:**
- **Excel ìˆ˜ì • ëŒ€ìƒ**: 6 insurers
- All recommended_fix_target = **EXCEL**
- ê¶Œì¥: Excel ë‹´ë³´ëª…mappingìë£Œ.xlsxì˜ ins_cd ê°’ì„ Pipeline ê¸°ì¤€ìœ¼ë¡œ ì •ì •

**Generated Reports:**
1. CSV: `data/step310_mapping/ins_cd_audit/ins_cd_audit_table.csv`
   - Per-insurer audit results
2. MD: `data/step310_mapping/ins_cd_audit/INSCD_AUDIT_REPORT.md`
   - Summary + Top 5 critical issues + recommendations
3. JSON: `data/step310_mapping/ins_cd_audit/ins_cd_audit_findings.json`
   - Machine-readable findings

**Constitution Compliance:**
- âœ… 3-way cross-validation (deterministic)
- âœ… 7 fixed issue codes (I1-I7)
- âœ… Audit reports only (no modifications)
- âŒ No Excel/code modifications
- âŒ No ins_cd inference/auto-correction

**DoD:**
- âœ… All insurers (8) audited
- âœ… CSV/MD/JSON reports generated
- âœ… Issue classification 100% applied
- âœ… No Excel/code modifications
- âœ… Reproducible audit

**Next Step:**
- STEP 3.10-Î¶: Excel ins_cd correction (based on audit findings)

---

### âœ… STEP 3.10-Î³: Excel Backlog Generator
**Commit:** f076b87 | **Date:** 2025-12-25

**Summary:**
- Excel ë³´ê°• ì‘ì—… ëª©ë¡ ìƒì„± (UNMAPPED â†’ Backlog)
- ë³´í—˜ì‚¬ë³„ backlog CSV (8ê°œ íŒŒì¼)
- ìˆ˜í•™ì  ìš°ì„ ìˆœìœ„ (occurrence_count DESC)
- ê·œì¹™ ê¸°ë°˜ recommended_action ë¶„ë¥˜

**Purpose:**
- Generate actionable Excel backlog for UNMAPPED coverages
- Per-insurer work lists (NO mapping changes)
- Prepare for STEP 3.10-Î´ (Excel enhancement)

**Processing Logic:**
1. Aggregate UNMAPPED by insurer + coverage_name_raw
2. Count occurrences
3. Classify recommended_action (rule-based)
4. Sort by priority (occurrence_count DESC)

**Recommended Action Classification (Rule-Based):**
- **ADD_EXCEL_ROW**: C1, C2, C6 í¬í•¨ (ë‹¨ìˆœ ì¶”ê°€ ê°€ëŠ¥)
- **STRUCTURAL_REVIEW**: C3, C4, C7 í¬í•¨ (êµ¬ì¡°ì  ê²€í†  í•„ìš”)
- **ADD_EXCEL_ROW_WITH_NOTE**: í˜¼í•© (ì¶”ê°€ ê°€ëŠ¥í•˜ë‚˜ ì£¼ì˜ í•„ìš”)

**Results:**
- Total backlog items: 157 (from 191 UNMAPPED rows)
- Per-insurer breakdown:
  - DB: 29 items (110 occurrences)
  - SAMSUNG: 37 items (37 occurrences)
  - LOTTE: 7 items (28 occurrences)
  - HYUNDAI: 27 items (27 occurrences)
  - HEUNGKUK: 23 items (23 occurrences)
  - MERITZ: 13 items (13 occurrences)
  - KB: 12 items (12 occurrences)
  - HANWHA: 9 items (9 occurrences)

**Generated Files:**
1. Per-insurer backlog CSVs: `data/step310_mapping/excel_backlog/backlog_{ins_cd}_{INSURER}.csv`
   - Schema: ins_cd, insurer_name, coverage_name_raw, occurrence_count, cause_codes, effect_codes, recommended_action, notes
2. Summary report: `data/step310_mapping/STEP310_GAMMA_EXCEL_BACKLOG_SUMMARY.md`
   - Per-insurer totals
   - Top 10 backlog per insurer
   - Expansion candidates vs structural review split
   - Expected impact (quantitative)

**Expected Impact:**
- ADD_EXCEL_ROW/WITH_NOTE: 157 items â†’ Excel ë³´ê°•ìœ¼ë¡œ í•´ì†Œ ê°€ëŠ¥
- STRUCTURAL_REVIEW: 9 items (ë³„ë„ ì „ëµ í•„ìš”)
- Excel ë³´ê°•ë§Œìœ¼ë¡œ í•´ì†Œ ê°€ëŠ¥: ~94.3%

**Constitution Compliance:**
- âœ… UNMAPPED â†’ Backlog (no state change)
- âœ… Rule-based recommended_action (deterministic)
- âœ… Mathematical priority (occurrence count)
- âœ… NO UNMAPPED â†’ MAPPED conversion
- âŒ No inference/semantic judgment
- âŒ No Excel modification

**DoD:**
- âœ… All UNMAPPED (191) â†’ backlog items (157 unique)
- âœ… Per-insurer backlog CSVs (8 files)
- âœ… recommended_action 100% assigned
- âœ… No judgment/inference sentences
- âœ… Reproducible (same input â†’ same backlog)
- âœ… Ready for STEP 3.10-Î´

---

### âœ… STEP 3.10-Î²: UNMAPPED Cause-Effect Analysis
**Commit:** d42289f | **Date:** 2025-12-25

**Summary:**
- UNMAPPED ì›ì¸ êµ¬ì¡°í™” (7ê°œ ê³ ì • Enum: C1-C7)
- ì‹œìŠ¤í…œ ì˜í–¥ ë¶„ë¥˜ (5ê°œ ê³ ì • Enum: E1-E5)
- ì‚¬ì‹¤ ê¸°ë°˜ ë¦¬í¬íŠ¸ ìƒì„± (í•´ì„/ì¶”ë¡ /ì¶”ì²œ ê¸ˆì§€)
- ë§¤í•‘ ë³´ê°•/UX ì„¤ëª…ì„ ìœ„í•œ ê·¼ê±° í™•ë³´

**Purpose:**
- Analyze WHY coverage is UNMAPPED (cause)
- Document system impact (effect)
- Provide evidence for future mapping enhancement decisions
- NO mapping rule changes, NO UNMAPPED â†’ MAPPED conversion

**Cause Classification (C1-C7):**
- C1_NO_EXCEL_ENTRY: Excelì— í•´ë‹¹ ë³´í—˜ì‚¬ ë§¤í•‘ í–‰ ì—†ìŒ
- C2_NAME_VARIANT_ONLY: íƒ€ ë³´í—˜ì‚¬ì—ëŠ” ì¡´ì¬í•˜ë‚˜ í˜„ì¬ ins_cd ë§¤í•‘ ì—†ìŒ
- C3_SUBCATEGORY_SPLIT: ê°€ì…ì„¤ê³„ì„œëŠ” í•˜ìœ„ ë‹´ë³´, Excelì€ ìƒìœ„ ê°œë…ë§Œ
- C4_COMPOSITE_COVERAGE: ê°€ì…ì„¤ê³„ì„œëŠ” ë‹¨ì¼ ë‹´ë³´, Excelì€ ë³µí•© ë‹´ë³´ë§Œ
- C5_NEW_OR_SPECIAL_COVERAGE: Excelì— ì •ì˜ë˜ì§€ ì•Šì€ ì‹ ê·œ/íŠ¹ìˆ˜ ë‹´ë³´
- C6_TERMINOLOGY_MISMATCH: ê³µë°±/ì ‘ë‘ì–´ ì°¨ì´ë¡œ ê²°ì •ë¡ ì  ë§¤ì¹­ ë¶ˆê°€
- C7_POLICY_LEVEL_ONLY: ê°€ì…ì„¤ê³„ì„œì—ëŠ” ìˆìœ¼ë‚˜ Excelì€ ì•½ê´€ ë‹¨ìœ„ë§Œ

**Effect Classification (E1-E5):**
- E1_COMPARISON_POSSIBLE: PRIME ë¹„êµ ê°€ëŠ¥ (in_universe_unmapped)
- E2_LIMITED_COMPARISON: ë‹¤ê±´ í›„ë³´/ì¶• ëˆ„ë½ìœ¼ë¡œ ì œí•œì  ë¹„êµ
- E3_EXPLANATION_REQUIRED: ê³ ê° ì‘ë‹µ ì‹œ ì„¤ëª… ë ˆì´ì–´ í•„ìˆ˜
- E4_MAPPING_EXPANSION_CANDIDATE: Excel ë³´ê°• ì‹œ MAPPED ê°€ëŠ¥ì„± ë†’ìŒ
- E5_STRUCTURAL_DIFFERENCE: êµ¬ì¡°ì  ì°¨ì´ë¡œ ë§¤í•‘ ìì²´ ë¶€ì í•©

**Analysis Results:**
- Total UNMAPPED analyzed: 191 cases
- Top cause: C1_NO_EXCEL_ENTRY (100% - all cases have this as primary/secondary cause)
- Expansion candidates (E4): 191 cases
- Structural differences (E5): 20 cases

**Generated Reports:**
1. CSV: `data/step310_mapping/unmapped_cause_effect_report.csv`
   - Schema: insurer, coverage_name_raw, cause_codes, effect_codes, evidence_note
2. MD: `data/step310_mapping/UNMAPPED_CAUSE_EFFECT_SUMMARY.md`
   - Overall statistics (cause distribution)
   - Per-insurer top causes
   - Frequent coverage names (Top 10)
   - Mapping expansion candidates
   - Structural difference cases

**Constitution Compliance:**
- âœ… Fact-based cause/effect classification only
- âœ… Evidence-based notes (no interpretation)
- âœ… NO mapping rule changes
- âœ… NO UNMAPPED â†’ MAPPED conversion
- âŒ No coverage unification/inference
- âŒ No recommendations/prioritization

**DoD:**
- âœ… 191 UNMAPPED cases fully analyzed
- âœ… All rows have cause_code (â‰¥1 per row)
- âœ… Effect codes assigned
- âœ… CSV + MD reports generated
- âœ… Reproducible (same input â†’ same output)

---

### âœ… STEP 3.13-Î±: Deterministic Query Variant Compiler
**Commit:** ec646cf | **Date:** 2025-12-25

**Summary:**
- Query-level whitespace variant handling (NO coverage normalization)
- Deterministic whitespace rules (ì§ˆë³‘ëª…+ì§„ë‹¨ë¹„/ìˆ˜ìˆ ë¹„/ì…ì›ë¹„ â†’ space variant)
- Resolves UX gap for í‘œê¸° ì°¨ì´ (e.g., "ì•”ì§„ë‹¨ë¹„" vs "ì•” ì§„ë‹¨ë¹„")
- NO PRIME state change, NO "same coverage" assertion

**Purpose:**
- Improve query matching for whitespace variations in proposal coverage names
- Query compilation only (ì§ˆì˜ ì»´íŒŒì¼ëŸ¬ ë³´ê°•)
- NO judgment modification (íŒê²°ë¬¸ ë¶ˆë³€)

**Query Variant Generation Rules:**
```
Original: "ì•”ì§„ë‹¨ë¹„"
Variants: ["ì•”ì§„ë‹¨ë¹„", "ì•” ì§„ë‹¨ë¹„"]

Pattern: (ì§ˆë³‘ëª…)(ì§„ë‹¨ë¹„|ìˆ˜ìˆ ë¹„|ì…ì›ë¹„|ì¹˜ë£Œë¹„|í›„ìœ ì¥í•´)
â†’ Generate: (ì§ˆë³‘ëª…) (suffix)
```

**Execution Flow:**
1. Try original query first
2. If original has in_universe hits â†’ use original result
3. If original all out_of_universe â†’ try variants
4. If variant hits â†’ add limitation reason: QUERY_VARIANT_APPLIED_NO_INFERENCE

**Constitution Compliance:**
- âœ… Query normalization ONLY (coverage_name_raw IMMUTABLE)
- âœ… Deterministic whitespace rules only
- âœ… NO PRIME state re-judgment
- âœ… NO "same coverage" assertion
- âŒ No LLM, no similarity, no morphological analysis
- âŒ No coverage unification

**Test Results:**
- âœ… T1 (Whitespace Effect): "ì•”ì§„ë‹¨ë¹„" â†’ variant "ì•” ì§„ë‹¨ë¹„" finds candidates
- âœ… T2 (Reproducibility): Same query â†’ Same result (100% deterministic)
- âœ… T3 (No Inference): No forbidden keywords (similarity/score/rank/semantic/embedding)

**DoD:**
- âœ… "ì•”ì§„ë‹¨ë¹„ / ì•” ì§„ë‹¨ë¹„" UX gap resolved
- âœ… PRIME constitution compliance (no violations)
- âœ… Comparison results IMMUTABLE
- âœ… Explanation factual only
- âœ… 100% reproducible
- âœ… All tests passed (T1/T2/T3)

---

### âœ… STEP 4.1: Proposal Detail Evidence Attachment (ê°€ì…ì„¤ê³„ì„œ ìƒì„¸ ê·¼ê±° ì²¨ë¶€)
**Commit:** c38f9cd | **Date:** 2025-12-25

**Summary:**
- Attach proposal detail evidence (ë³´ì¥ë‚´ìš© ì›ë¬¸) to customer response
- Extract evidence from proposal detailed_table/text_blocks ONLY
- Deterministic matching framework (exact â†’ substring â†’ no_match)
- Template profile-based location hints (STEP 3.9-0 integration)

**Purpose:**
- Provide ë³´ì¥ë‚´ìš© (coverage details) evidence from proposal internal documents
- Add [ë³´ì¥ë‚´ìš© ê·¼ê±°] section to STEP 4.0 customer response
- NO inference, NO summarization, NO policy/summary reference (this STEP only)

**Evidence Attachment Structure:**
```
[ë³´ì¥ë‚´ìš© ê·¼ê±° (ê°€ì…ì„¤ê³„ì„œ ìƒì„¸)]

â–¶ INSURER - COVERAGE_NAME

- source: PROPOSAL
- evidence_found: true|false
- evidence_excerpt:
  """
  (ì›ë¬¸ ê·¸ëŒ€ë¡œ, 1~6ì¤„)
  """
- evidence_location:
  - page_hint: "pages 4-7" | NULL
  - section_hint: "ë‹´ë³´ë³„ ë³´ì¥ë‚´ìš©" | NULL
  - match_rule: exact|substring|no_match
```

**Matching Rules (Deterministic):**
1. exact match: coverage_name_raw == row_coverage_name
2. substring match: coverage_name_raw in row_coverage_name
3. no_match: evidence_found=false

**Normalization Allowed:**
- âœ… Whitespace collapse (multiple â†’ single)
- âœ… Strip leading/trailing whitespace
- âŒ NO special character removal
- âŒ NO synonym expansion

**Template Profile Integration:**
- Loaded from `data/step39_coverage_universe/profiles/*_template_profile.yaml`
- Uses `detailed_table.location`, `detailed_table.table_name` for hints
- Graceful degradation if profile not available

**Current Implementation Status:**
- âœ… Framework complete (deterministic matching + evidence structure)
- âœ… Template profile integration
- âœ… Placeholder evidence generation
- â³ Actual PDF extraction (future STEP)

**Constitution Compliance:**
- âœ… STEP 3.11/3.12/3.13/4.0 results IMMUTABLE
- âœ… Proposal internal evidence only
- âœ… Deterministic matching only
- âŒ No PRIME state changes
- âŒ No comparison result modification
- âŒ No inference/semantic matching
- âŒ No policy/summary/business_rules reference (this STEP)

**Determinism Verification:**
- âœ… Test script: `test_step41_determinism.py`
- âœ… 3 sample queries executed:
  - "ì‚¼ì„±ê³¼ í•œí™” ì•”ì§„ë‹¨ë¹„ ë¹„êµí•´ì¤˜"
  - "KB ë¡¯ë° ë‡Œì¡¸ì¤‘ì§„ë‹¨ë¹„ ë³´ì—¬ì¤˜"
  - "ë‹¤ë¹ˆì¹˜ìˆ˜ìˆ ë¹„"
- âœ… All tests passed: Same query â†’ Same output

**DoD:**
- âœ… STEP 4.0 output structure maintained + evidence section added
- âœ… Proposal internal evidence extraction framework
- âœ… Deterministic matching rules implemented
- âœ… Template profile integration
- âœ… 100% reproducible (determinism verified)
- âœ… 3 sample queries executed with evidence attachment

**Next Steps:**
- STEP 4.2: Actual PDF extraction (replace placeholder evidence)
- STEP 4.3: Policy/summary reference (if proposal insufficient)

---

### âœ… STEP 4.0: Customer Response Formatter (ì¶œë ¥ ì „ìš© ë ˆì´ì–´)
**Commit:** 2883dff | **Date:** 2025-12-25

**Summary:**
- Customer-friendly output formatter (presentation-only layer)
- Transforms STEP 3.13 results into customer-readable format
- 100% IMMUTABLE (no PRIME state changes, no recalculation)
- Fixed 3-section structure: Summary Header â†’ Fact Table â†’ Explanation Blocks

**Purpose:**
- Display STEP 3.11 + STEP 3.12 results in customer-friendly format
- Presentation ONLY (no judgment, no modification, no inference)

**Output Structure:**
```
[ë¹„êµ ìš”ì•½]
- Coverage query
- Target insurers
- Comparison status (ì™„ì „ ë¹„êµ ê°€ëŠ¥ / ì œí•œì  ê°€ëŠ¥ / ë¹„êµ ë¶ˆê°€)
- Limitation reasons (ì§ì ‘ ì „ë‹¬)

[ë¹„êµ í…Œì´ë¸”]
- STEP 3.11 comparison table (IMMUTABLE)
- PRIME state â†’ customer labels mapping
- Sorted by insurer name

[ë³´í—˜ì‚¬ë³„ ìƒì„¸ ì„¤ëª…]
- STEP 3.12 explanation blocks (IMMUTABLE)
- Per-insurer reasoning (no sentence modification)
```

**PRIME State â†’ Customer Label Mapping:**
- `in_universe_comparable` â†’ "ë¹„êµ ê°€ëŠ¥"
- `in_universe_with_gaps` â†’ "ì œí•œì  ë¹„êµ ê°€ëŠ¥"
- `in_universe_unmapped` â†’ "ë¹„êµ ê°€ëŠ¥ (í‘œì¤€ ì½”ë“œ ë¯¸ëŒ€ì‘)"
- `out_of_universe` â†’ "ë¹„êµ ëŒ€ìƒ ì•„ë‹˜"

**Forbidden Phrase Validation:**
- Hard ban on recommendation/inference phrases
- Validation: "ì‚¬ì‹¤ìƒ ê°™ì€ ë‹´ë³´", "ìœ ì‚¬í•œ ë‹´ë³´", "ì¶”ì²œí•©ë‹ˆë‹¤", "ì„ íƒí•˜ì„¸ìš”", etc.
- System fails if any forbidden phrase detected

**Constitution Compliance:**
- âœ… STEP 3.11 results IMMUTABLE (íŒê²°ë¬¸)
- âœ… STEP 3.12 explanations IMMUTABLE (ì´ìœ ì„œ)
- âœ… STEP 4.0 presentation only (ì¶œë ¥)
- âŒ No PRIME state changes
- âŒ No result recalculation
- âŒ No coverage integration
- âŒ No similarity judgment
- âŒ No recommendations

**DoD:**
- âœ… STEP 3.13 result â†’ Customer-friendly format
- âœ… 100% IMMUTABLE (no changes to STEP 3.11/3.12)
- âœ… Forbidden phrase validation enforced
- âœ… Same input â†’ Same output
- âœ… No Constitution violations

**Example Output:**
```
[ë¹„êµ ìš”ì•½]
ìš”ì²­í•˜ì‹  ë‹´ë³´: ì•”ì§„ë‹¨ë¹„
ë¹„êµ ë³´í—˜ì‚¬: SAMSUNG, HANWHA
ë¹„êµ ê²°ê³¼ ìš”ì•½:
- ë¹„êµ ê°€ëŠ¥ ì—¬ë¶€: ì œí•œì  ê°€ëŠ¥
- ì œí•œ ì‚¬ìœ :
  â€¢ GAPS_PRESENT (1 insurers)
  â€¢ OUT_OF_UNIVERSE (1 insurers)

[ë¹„êµ í…Œì´ë¸”]
  ë³´í—˜ì‚¬    ë‹´ë³´ëª…    PRIME ìƒíƒœ
 SAMSUNG      -  ë¹„êµ ëŒ€ìƒ ì•„ë‹˜
  HANWHA ì•”ì§„ë‹¨ë¹„ ì œí•œì  ë¹„êµ ê°€ëŠ¥

[ë³´í—˜ì‚¬ë³„ ìƒì„¸ ì„¤ëª…]
â–¶ SAMSUNG
íŒë‹¨ ê²°ê³¼: ë¹„êµ ëŒ€ìƒ ì•„ë‹˜
ì‚¬ìœ : [STEP 3.12 explanation - IMMUTABLE]
```

---

### âœ… STEP 3.13: Query Pipeline (THE LAST STEP)
**Commit:** f21f6e4 | **Date:** 2025-12-25

**Summary:**
- User query â†’ PRIME comparison pipeline connector
- Natural language query parsing (deterministic)
- Automatic STEP 3.11 â†’ STEP 3.12 orchestration
- 100% reproducibility verified

**Purpose:**
- Connect natural language queries to comparison engine
- Query interpretation + routing ONLY
- NO comparison logic (already in STEP 3.11/3.12)

**Pipeline Flow:**
```
User Query
  â†“
Query Parsing (insurers + coverage keyword)
  â†“
STEP 3.11 (Comparison Engine)
  â†“
STEP 3.12 (Explanation Layer)
  â†“
ExplainedComparisonResult
```

**Example Results:**
- "ì‚¼ì„±ê³¼ í•œí™” ì•”ì§„ë‹¨ë¹„ ë¹„êµí•´ì¤˜"
  - Coverage: "ì•”ì§„ë‹¨ë¹„"
  - Insurers: SAMSUNG, HANWHA
  - SAMSUNG: out_of_universe
  - HANWHA: in_universe_with_gaps (5ê±´)

- "KB ë¡¯ë° ë‡Œì¡¸ì¤‘ì§„ë‹¨ë¹„ ë³´ì—¬ì¤˜"
  - Coverage: "ë‡Œì¡¸ì¤‘ì§„ë‹¨ë¹„"
  - Insurers: KB, LOTTE
  - KB: in_universe_comparable
  - LOTTE: in_universe_with_gaps (2ê±´)

**Query Parsing (Deterministic):**
- âœ… Insurer extraction: ì‚¼ì„± â†’ SAMSUNG, í•œí™” â†’ HANWHA, etc.
- âœ… Common word removal: ë¹„êµí•´ì¤˜, ë³´ì—¬ì¤˜, etc.
- âœ… Whitespace normalization only
- âŒ No semantic inference
- âŒ No coverage expansion

**Reproducibility:**
- âœ… Same query â†’ Same result
- âœ… 100% REPRODUCIBLE

**DoD:**
- âœ… One-line question â†’ PRIME result
- âœ… 100% reproducibility verified
- âœ… No state changes, no re-judgment

**This is THE LAST STEP of the core pipeline.**

All subsequent work (UI, formatting, recommendations, policy expansion) builds on this foundation.

---

### âœ… STEP 3.12: PRIME Explanation Layer (Immutable)
**Commit:** 7e6d97e | **Date:** 2025-12-25

**Summary:**
- Explanation layer for PRIME comparison results
- STEP 3.11 results are IMMUTABLE (íŒê²°ë¬¸)
- STEP 3.12 provides reasoning only (ì´ìœ ì„œ)
- No state changes, no re-judgment, no recommendations

**Purpose:**
- Answers ONLY: "ì´ PRIME ê²°ê³¼ê°€ ë‚˜ì˜¨ ì‚¬ì‹¤ì  ì´ìœ ëŠ” ë¬´ì—‡ì¸ê°€?"
- Does NOT answer: "ì–´ëŠ ë‹´ë³´ê°€ ë” ë‚«ë‹¤" / "ì‚¬ì‹¤ìƒ ê°™ì€ ë‹´ë³´ë‹¤" / "ì¶”ì²œí•œë‹¤"

**PRIME State Explanations:**
- `out_of_universe`: ìš”ì•½í‘œì— í•´ë‹¹ ë‹´ë³´ ì—†ìŒ
- `in_universe_with_gaps`: Nê±´ í›„ë³´ ì¡´ì¬ ë˜ëŠ” ì¶• ì •ë³´ ëˆ„ë½ (ì˜ë¯¸ ì¶”ë¡  ë¶ˆê°€)
- `in_universe_unmapped`: ê°€ì…ì„¤ê³„ì„œ ì¡´ì¬í•˜ë‚˜ ì‹ ì •ì› ì½”ë“œ ë¯¸ëŒ€ì‘
- `in_universe_comparable`: ë‹¨ì¼ ë‹´ë³´, ëª¨ë“  ì¶• ì¡´ì¬

**Output Structure:**
```json
{
  "comparison_result": { ... STEP 3.11 original ... },
  "explanation": {
    "summary": "ì „ì²´ ìš”ì•½",
    "details": [ë³´í—˜ì‚¬ë³„ ìƒì„¸ ì„¤ëª…]
  }
}
```

**Immutability Verification:**
- âœ… Test: `test_step312_immutability.py`
- âœ… Result: NO CHANGES - IMMUTABILITY VERIFIED

**Constitution Compliance:**
- âœ… PRIME ìƒíƒœ ë³€ê²½ ì—†ìŒ
- âœ… ì¶”ë¡ /ì˜ë¯¸ í†µí•© ì—†ìŒ
- âœ… ì‚¬ì‹¤ ê¸°ë°˜ ì„¤ëª…ë§Œ ì œê³µ
- âœ… STEP 3.11 ê²°ê³¼ 100% ì¬í˜„ ê°€ëŠ¥

---

### âœ… STEP 3.11â€² HOTFIX: PRIME-aligned Comparison Engine
**Commit:** 6dbb6ae | **Date:** 2025-12-25

**Summary:**
- Replaced similarity-based matching with deterministic substring search
- Implemented PRIME 4-State classification (in_universe_comparable/unmapped/with_gaps, out_of_universe)
- Fact-based comparison table only (no inference)
- Verified no AMBIGUOUS/similarity/score in output

**PRIME 4-State Rules:**
- `in_universe_comparable`: MAPPED + all core axes present
- `in_universe_unmapped`: Found but UNMAPPED
- `in_universe_with_gaps`: MAPPED but missing axes OR multiple candidates
- `out_of_universe`: Not found in proposal

**Constitution Compliance:**
- âœ… Proposal = SSOT (Fact Table only)
- âœ… Substring search only (no inference)
- âœ… Multiple candidates â†’ WITH_GAPS + MULTIPLE_CANDIDATES_NO_INFERENCE
- âœ… Shinjeongwon code = reference key (NOT filter/primary)
- âœ… UNMAPPED â‰  "similar coverage"

**Sample Results Verified:**
- ì•”ì§„ë‹¨ë¹„: OUT_OF_UNIVERSE(SAMSUNG), WITH_GAPS(HANWHA 5ê±´, MERITZ 4ê±´)
- ë‡Œì¡¸ì¤‘ì§„ë‹¨ë¹„: OUT_OF_UNIVERSE(SAMSUNG), COMPARABLE(KB), WITH_GAPS(LOTTE 2ê±´)
- ë‹¤ë¹ˆì¹˜ìˆ˜ìˆ ë¹„: OUT_OF_UNIVERSE(ì „ì²´) â†’ ë¹„êµ ë¶ˆê°€

---

### âœ… STEP 3.10: Proposal Coverage â†’ Shinjeongwon Reference Mapping
**Commit:** 4d89681 | **Date:** 2025-12-25

**Summary:**
- Non-destructive reference mapping (ìƒíƒœ íƒœê¹… ì „ìš©)
- Mapped 334 proposal coverages to Shinjeongwon codes
- Results: MAPPED (140, 41.9%), AMBIGUOUS (129, 38.6%), UNMAPPED (65, 19.5%)
- No coverage unification, no code enforcement, no normalization
- Reference mapping only

**Outputs:**
- `data/step310_mapping/proposal_coverage_mapping.csv` (334 rows)
- `data/step310_mapping/mapping_report.txt` (validation report)

**Constitution Compliance:**
- âœ… ê°€ì…ì„¤ê³„ì„œ ì›ë³¸ ë³´ì¡´ (ë¹„íŒŒê´´)
- âœ… ì‹ ì •ì› ì½”ë“œ ê°•ì œ ë¶€ì—¬ ê¸ˆì§€
- âœ… ë‹´ë³´ í†µí•©/íŒë‹¨/ì •ê·œí™” ê¸ˆì§€
- âœ… ì°¸ì¡°(reference) ë§¤í•‘ë§Œ ìˆ˜í–‰
- âœ… STEP 3.11ë¡œ ì¦‰ì‹œ ì´í–‰ ê°€ëŠ¥

---

### âš ï¸ STEP 33-Î²-2d: Customer Clarification Pending
**Commit:** (pending) | **Date:** 2025-12-25

**Summary:**
- Premium API integration **BLOCKED** - Upstream returns 400 with empty body
- All client-side/proxy implementations verified correct
- Tested variations: Korean/ASCII customerNm, browser headers, parameter combinations
- All tests return same 400 from nginx (before application layer)
- Spec indicates "Public API - no authentication", but actual behavior suggests access restrictions

**Customer Clarification Request Created:**
- Document: `docs/api/premium_api_customer_clarification.md`
- Required information:
  - Correct base URL / environment
  - Authentication requirements (API key, session, IP whitelist)
  - Required headers or additional parameters
  - Working curl/Postman sample request
  - Access restrictions (WAF, rate limit, geographic)

**SSOT Updated:**
- `docs/api/premium_api_spec.md` status: "Spec/Access Requirement Mismatch Suspected"
- Live observation section added with test evidence
- Integration status: BLOCKED pending customer response

**Next Step:**
- Await customer clarification
- Do NOT proceed with authentication guesses or parameter additions
- Resume integration only after receiving verified access method

---

### âœ… STEP 33-Î²-2: Browser Header Parity Mode
**Commit:** 9bc7ff3 | **Date:** 2025-12-25

**Summary:**
- Added `PREMIUM_UPSTREAM_HEADER_MODE=browser` environment variable
- Mimics browser headers (User-Agent, Referer, Accept-Language, etc.)
- Created curl reproduction script: `apps/web/scripts/premium_upstream_curl.sh`
- Result: No change - still 400 with empty body
- Conclusion: Header configuration not the issue

---

### âœ… STEP 33-Î²-1e: Upstream Meta Logging
**Commit:** 405e94f | **Date:** 2025-12-25

**Summary:**
- Added response metadata logging for both success and failure cases
- Logs status, url, content-type, content-length, server, date
- Confirmed nginx 400 with Content-Length: 0, bodyLen: 0
- Evidence captured for customer clarification

---

### âœ… STEP 33-Î²-1b: Upstream 400 Diagnosis Logging
**Commit:** fa96c57 | **Date:** 2025-12-25

**Summary:**
- Added guaranteed logging to Premium proxy routes for 400 error diagnosis
- Module load log: `ğŸš¨ [premium:<route>] module loaded`
- Handler entry log: `ğŸš¨ [premium:<route>] handler entered`
- Request body, params, full upstream URL logging
- Upstream error body capture (up to 500 chars in response, full in console)
- Purpose: Identify whether 400 is from routing issue or upstream validation
- /compare contract unchanged âœ… (zero diff)

**Logs Added:**
```
ğŸš¨ [premium:simple-compare] handler entered
[Premium Simple] body: {...}
[Premium Simple] params: baseDt=...&birthday=...
[Premium Simple] upstreamFullUrl: https://.../public/prdata/prInfo?...
[Premium Simple] upstream error body: <full text>
```

**Next:** User clicks DEV buttons â†’ Copy terminal logs â†’ Analyze upstream 400 root cause

---

### âœ… STEP 33-Î²-1: DEV Premium Triggers (Live Capture UI)
**Commit:** 1864f5c | **Date:** 2025-12-25

**Summary:**
- Added 2 DEV buttons to `apps/web/src/pages/index.tsx` for Premium API testing
- Buttons: `[DEV] Premium Simple Compare`, `[DEV] Premium Onepage Compare`
- Purpose: Generate live Network requests for Request/Response payload capture
- Request payloads based on SSOT (`docs/api/premium_api_spec.md`)
- Fixed test values: baseDt=20251225, birthday=19760101, age=50, sex=1, customerNm=í™ê¸¸ë™
- /compare contract unchanged âœ… (zero diff in apps/api, tests/snapshots)

**DoD:**
- âœ… UI triggers visible at http://localhost:3000 (orange DEV section)
- âœ… Network tab captures POST /api/premium/simple-compare & onepage-compare
- âœ… Request/Response JSON available for manual copy
- âœ… Zero impact on /compare

---

### âœ… STEP 33-Î±: CORS Preflight Fix
**Commit:** 59af9e9 | **Date:** 2025-12-25

**Summary:**
- Added CORS middleware to FastAPI (allows OPTIONS preflight from http://localhost:3000)
- Env-controlled via `CORS_ORIGINS` (defaults to localhost:3000 for dev)
- OPTIONS /compare now returns 200 with proper CORS headers
- /compare business logic unchanged âœ…
- /compare snapshots unchanged âœ…

---

### âš ï¸ STEP 32-Î»-2: Truth Lock Hotfix
**Commit:** 9c85092 | **Date:** 2025-12-25

**Summary:**
- Corrected misleading "Verified" claims in Premium API spec
- Reclassified verification status to 3-tier structure:
  - **A. Spec-confirmed** (documented in SSOT)
  - **B. Fixture-tested** (offline, does NOT confirm live behavior)
  - **C. Live-observed** (PENDING - not executed)
- Defensive handling explicitly marked as unobserved
- Removed inactive `adapter.test.ts` (no test framework configured)
- Authoritative test: `apps/web/scripts/premium_adapter_smoke.mjs`
- No behavior change âœ…
- /compare regression lock: 0 diff âœ…

---

### âœ… STEP 32-Î»: Fixture-Based Regression Tests
**Commit:** 427da8c, 0274c91 | **Date:** 2025-12-25

**Summary:**
- Created 3 SSOT-based test fixtures (prInfo, prDetail, wrapped)
- Added adapter regression tests (5 scenarios, network-independent)
- Smoke test script: `node apps/web/scripts/premium_adapter_smoke.mjs`
- Initial attempt at verification documentation (corrected in Î»-2)
- /compare regression lock: 0 diff âœ…

---

### âœ… STEP 32-Îº-POST-2: SSOT Wording Tightening
**Commit:** 409b6b0 | **Date:** 2025-12-25

**Summary:**
- All SSOT references now point to `docs/api/premium_api_spec.md` (not upstream files)
- Removed assertions about "actual upstream behavior" (replaced with "SSOT does not document")
- Comment/doc wording only (no behavior change)
- TypeScript typecheck: PASS âœ…
- /compare regression lock: 0 diff âœ…

---

### âœ… STEP 32-Îº-POST: Types/Docs Cleanup (Spec-Driven)
**Commit:** 95f18f4 | **Date:** 2025-12-25

**Summary:**
- Replaced generic `UpstreamPremiumResponse` with spec-based types (`UpstreamPrInfoResponse`, `UpstreamPrDetailResponse`)
- Removed forced `data` wrapper assumption (defensive union type instead)
- README smoke tests clarified: POSTâ†’GET conversion, dual response structures
- Deprecated `premium_api_spec_minimal.md` (legacy placeholder)
- /compare regression lock maintained âœ…

---

### âœ… STEP 32-Îº-FIX: Adapter Response Structure Support
**Commit:** 3469262 | **Date:** 2025-12-25

**Summary:**
- Fixed adapter to support both prInfo (simple) and prDetail (onepage) response shapes
- prInfo: basePremium from `outPrList[].monthlyPrem`
- prDetail: basePremium from `prProdLineCondOutIns[].monthlyPremSum`
- Spec-driven field extraction (no assumptions)
- /compare regression lock maintained âœ…

---

### âœ… STEP 32-Î´: Premium UI Wiring Hardening + Mocks Separation
**Commit:** d1f1877 | **Date:** 2025-12-25
**Details:** [docs/status/2025-12-25_step-32-delta.md](docs/status/2025-12-25_step-32-delta.md)

**Summary:**
- Moved `convertProxyResponseToCards()` from mocks to production bridge
- Eliminated fake proposalId generation (optional field)
- Hardened failure rendering (explicit MISSING cards, never blank screens)
- /compare regression lock maintained âœ…

---

### âœ… STEP 32: Premium API Integration (Real basePremium)
**Commit:** 678eb8d | **Date:** 2025-12-25
**Details:** [docs/status/2025-12-25_step-32.md](docs/status/2025-12-25_step-32.md)

**Summary:**
- Real basePremium from Premium API (monthlyPremSum ONLY)
- Proxy routes: `/api/premium/simple-compare`, `/onepage-compare`
- Coverage name unmapped â†’ graceful PARTIAL (not error)
- /compare contract/snapshots UNTOUCHED âœ…

---

### âœ… STEP 31-Î±: General Premium Multiplier Table Integration
**Commit:** 59f562b | **Date:** 2025-12-25
**Details:** [docs/status/2025-12-25_step-31-alpha.md](docs/status/2025-12-25_step-31-alpha.md)

**Summary:**
- Embedded Excel multiplier table as SSOT (frontend)
- Real multipliers applied to â‘¡ì¼ë°˜ premium calculation
- Coverage name â†’ multiplier lookup (graceful degradation)

---

### âœ… STEP 31: Premium Calculation UI Logic
**Commit:** 23aac38 | **Date:** 2025-12-25

**Summary:**
- Frontend premium calculation (READY/PARTIAL/MISSING states)
- PlanType: â‘ ì „ì²´ / â‘¡ì¼ë°˜ / â‘¢ë¬´í•´ì§€
- Mock-based UI testing (no backend changes)

---

### âœ… STEP 28: Contract-Driven Frontend MVP
**Commit:** 4fd4a5c | **Date:** 2025-12-24

**Summary:**
- Next.js frontend with contract-driven view resolution
- 5 view components based on backend contract states
- DEV_MOCK_MODE for golden snapshot testing

---

### âœ… STEP 14: Compare API E2E Integration
**Commit:** Multiple | **Date:** 2025-12-23

**Summary:**
- `/compare` endpoint with golden snapshots
- 5-state comparison system (comparable/unmapped/policy_required/out_of_universe/non_comparable)
- Evidence-based responses with document references

---

### âœ… STEP 6-C: Proposal Universe Lock
**Commit:** Multiple | **Date:** 2025-12-23

**Summary:**
- Proposal coverage universe as single source of truth
- Excel-based coverage mapping (no LLM inference)
- 3-tier disease code model (KCD-7 + insurance groups)

---

### âœ… STEP 5-B: DB Read-Only Implementation
**Commit:** Multiple | **Date:** 2025-12-23

**Summary:**
- PostgreSQL read-only enforcement (4 layers)
- Entity-based evidence filtering
- is_synthetic=false hard-coded

---

### âœ… STEP 5-A: OpenAPI Contract + FastAPI Skeleton
**Commit:** c102751 | **Date:** 2025-12-23

**Summary:**
- OpenAPI 3.0.3 contract
- FastAPI with 3 endpoints
- Contract tests (8/8 PASS)

---

### Earlier Steps (STEP 1-13)

Detailed logs available in:
- [docs/status/legacy_STATUS_full.md](docs/status/legacy_STATUS_full.md)

**Key accomplishments:**
- Database schema design
- LLM ingestion pipeline
- Docker E2E testing framework
- Minimal seed data

---

## Current Status

**Active Branch:** main
**Latest Commit:** dc3e332

**Completed Work:**
- âœ… Backend /compare API (immutable contract)
- âœ… Frontend contract-driven UI
- âœ… Premium API integration (additional feature)
- âœ… Coverage mapping via Excel SSOT
- âœ… Docker E2E testing

**In Progress:**
- Premium UI/UX refinement
- Documentation consolidation

**Next Steps:**
1. Coverage name normalization pipeline
2. Admin UI for AMBIGUOUS coverage mapping
3. Disease code group management interface

**Blockers:** None

---

## Constitutional Guarantees

All work adheres to [CLAUDE.md](CLAUDE.md) constitution:

- âœ… **Coverage Universe Lock**: ê°€ì…ì„¤ê³„ì„œ = SSOT for comparison targets
- âœ… **Deterministic Compiler**: No LLM inference for coverage/disease mappings
- âœ… **Evidence Rule**: All data has document references
- âœ… **Disease Code Authority**: KCD-7 official distribution only
- âœ… **Document Hierarchy**: Proposal > Summary > Business Rules > Policy
- âœ… **/compare Immutability**: Contract/snapshots never modified

---

## Key Documentation

**Constitution:**
- [CLAUDE.md](CLAUDE.md) - Project constitution (highest authority)

**Implementation Guides:**
- [apps/web/README.md](apps/web/README.md) - Frontend setup + Premium smoke tests
- [apps/api/README.md](apps/api/README.md) - Backend API documentation

**Status Logs:**
- [docs/status/](docs/status/) - Detailed milestone logs
- [docs/status/legacy_STATUS_full.md](docs/status/legacy_STATUS_full.md) - Full historical archive

**OpenAPI Contract:**
- [openapi/step5_openapi.yaml](openapi/step5_openapi.yaml) - /compare API contract

---

## Quick Commands

### Backend
```bash
# Contract tests (DB-agnostic)
pytest tests/contract -q

# Integration tests (real DB)
pytest tests/integration -q

# E2E tests (Docker)
pytest tests/e2e -q

# All tests
pytest -q
```

### Frontend
```bash
cd apps/web

# Development (mock mode)
export DEV_MOCK_MODE=1
pnpm dev

# Development (real API)
export DEV_MOCK_MODE=0
export API_BASE_URL=http://localhost:8000
pnpm dev

# Production build
pnpm build
```

### Database
```bash
# Connect to local PostgreSQL
psql -U postgres -d inca_rag_final

# Run migrations
python migrations/run_migration.py
```

---

## Environment Variables

### Backend (`apps/api/.env`)
```bash
DATABASE_URL=postgresql://user:pass@localhost:5432/inca_rag_final
```

### Frontend (`apps/web/.env.local`)
```bash
DEV_MOCK_MODE=0  # 0=real API, 1=mocks
API_BASE_URL=http://localhost:8000
PREMIUM_API_BASE_URL=https://api.premium-service.example.com
PREMIUM_API_KEY=your_api_key_here  # Optional
```

---

## Project Structure

```
inca-RAG-final/
â”œâ”€â”€ CLAUDE.md                 # Constitution (highest authority)
â”œâ”€â”€ STATUS.md                 # This file (project index)
â”œâ”€â”€ apps/
â”‚   â”œâ”€â”€ api/                  # FastAPI backend
â”‚   â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”‚   â”œâ”€â”€ routers/      # /compare endpoints
â”‚   â”‚   â”‚   â”œâ”€â”€ db.py         # Read-only DB connection
â”‚   â”‚   â”‚   â””â”€â”€ policy.py     # Policy enforcement
â”‚   â”‚   â””â”€â”€ tests/
â”‚   â””â”€â”€ web/                  # Next.js frontend
â”‚       â”œâ”€â”€ src/
â”‚       â”‚   â”œâ”€â”€ components/   # UI components
â”‚       â”‚   â”œâ”€â”€ contracts/    # UI state map (SSOT)
â”‚       â”‚   â””â”€â”€ lib/
â”‚       â”‚       â”œâ”€â”€ api/      # API clients + premium bridge
â”‚       â”‚       â””â”€â”€ premium/  # Premium calculation logic
â”‚       â””â”€â”€ README.md         # Frontend docs + smoke tests
â”œâ”€â”€ docs/
â”‚   â””â”€â”€ status/               # Detailed milestone logs
â”œâ”€â”€ data/                     # Insurance documents + mappings
â”œâ”€â”€ migrations/               # Database migrations
â”œâ”€â”€ openapi/                  # OpenAPI contracts
â””â”€â”€ tests/
    â”œâ”€â”€ contract/             # Contract tests
    â”œâ”€â”€ integration/          # Integration tests
    â””â”€â”€ e2e/                  # E2E tests
```

---

## Contact & Support

**Issues:** https://github.com/jason-dio-so/inca-rag-final/issues
**Documentation:** See `docs/` and `apps/*/README.md`
**Constitution:** [CLAUDE.md](CLAUDE.md) (all rules and principles)

---

**Last Full Archive:** [docs/status/legacy_STATUS_full.md](docs/status/legacy_STATUS_full.md) (3194 lines)
**This Index:** ~320 lines (10Ã— reduction for accessibility)

---

### âœ… STEP 32-Îº: Premium API Spec-Driven Lock
**Commit:** [pending] | **Date:** 2025-12-25

**Summary:**
- Locked Premium integration to actual upstream specifications (spec-driven, zero assumptions)
- basePremium sources: `monthlyPrem` (simple) / `monthlyPremSum` (onepage)
- Upstream method: GET (not POST), insurer codes: N01-N13 format
- README curl examples now executable with real payload structure


### âœ… STEP NEXT-10-Î²: ViewModel Assembler v2 + Example E2E Tests (Complete)
**Commit:** [pending] | **Date:** 2025-12-26

**Summary:**
- ViewModel Assembler v2 êµ¬í˜„ (schema v2 í•„ë“œ ì§€ì›)
- Forbidden Phrase Guard í…ŒìŠ¤íŠ¸ ì¶”ê°€
- Example 1-4 E2E í…ŒìŠ¤íŠ¸ ì¶”ê°€
- ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼ (12 passed)

**ëª©ì :**
- LOCKED ViewModel schema v2(Commit 1f85282)ë¥¼ ì‹¤ì œ ëŸ°íƒ€ì„ ì‚°ì¶œë¬¼ë¡œ êµ¬í˜„
- ì¶”ì²œ/ìš°ì—´/í•´ì„/ì¶”ë¡  ë¬¸êµ¬ ìƒì„± ì°¨ë‹¨ (í…ŒìŠ¤íŠ¸ ê¸°ë°˜)
- INCA DIO ìš”êµ¬ì‚¬í•­(Example 1-4) E2E ê²€ì¦

**ì£¼ìš” ë³€ê²½ ì‚¬í•­:**

1. **ViewModel Types í™•ì¥ (schema v2)**
   - `FilterCriteria`: insurer_filter, disease_scope, slot_key, difference_detected
   - `SortMetadata`: sort_by, sort_order, limit (UI hint)
   - `VisualEmphasis`: min_value_style, max_value_style (UI hint)
   - `FactTableRow.highlight`: ì°¨ì´ ê°ì§€ ì…€ ê°•ì¡° (fact-only)
   - `FactTable.table_type`: default | ox_matrix

2. **Assembler v2 êµ¬í˜„**
   - íŒŒì¼: `apps/api/app/view_model/assembler.py`
   - v2 í•„ë“œëŠ” optional, í•„ìš”ì‹œì—ë§Œ ì±„ì›€
   - schema_version = "next4.v2"
   - ê¸°ì¡´ assembler ê¸°ëŠ¥ ìœ ì§€ (non-breaking)

3. **Forbidden Phrase Guard**
   - íŒŒì¼: `tests/test_next10_forbidden_phrases.py`
   - ì •ê·œì‹ ê¸°ë°˜ ê¸ˆì§€ í‘œí˜„ ê²€ì¦
   - ì¶”ì²œ/ìš°ì—´/í•´ì„/ì¶”ë¡  ë¬¸êµ¬ ê°ì§€
   - ë„ë©”ì¸ ìš©ì–´ ì˜ˆì™¸ ì²˜ë¦¬ ("ìœ ì‚¬ì•”" í—ˆìš©)

4. **Example 1-4 E2E Tests**
   - íŒŒì¼: `tests/test_next10_examples_e2e.py`
   - Example 1: ë³´í—˜ë£Œ ì •ë ¬ ë¹„êµ
   - Example 2: ë³´ì¥í•œë„ ì°¨ì´ ê°ì§€
   - Example 3: íŠ¹ì • ë³´í—˜ì‚¬ ë¹„êµ
   - Example 4: ì§ˆë³‘ë³„ O/X ë§¤íŠ¸ë¦­ìŠ¤
   - Schema v2 ê²€ì¦ + Forbidden Phrase Guard

**í…ŒìŠ¤íŠ¸ ê²°ê³¼:**
```
tests/test_next10_examples_e2e.py: 5 passed
tests/test_next10_forbidden_phrases.py: 7 passed
Total: 12 passed, 32 warnings (pydantic deprecation)
```

**Constitutional Compliance:**
- âœ… Article II: Deterministic Compiler (assemblerëŠ” ë§¤í•‘ë§Œ, ì¶”ë¡  ê¸ˆì§€)
- âœ… Article III: Evidence Rule (ëª¨ë“  ê°’ì— evidence_ref_id)
- âœ… ê¸ˆì§€ ì‚¬í•­ ì¤€ìˆ˜ (ì¶”ì²œ/ìš°ì—´/í•´ì„/ì¶”ë¡  ë¬¸êµ¬ ìƒì„± ê¸ˆì§€)
- âœ… Schema v2 ì¤€ìˆ˜ (JSON Schema validation)

**DoD (Definition of Done):**
- [x] Assemblerê°€ schema v2 ViewModelì„ ì‹¤ì œë¡œ ìƒì„±
- [x] forbidden phrase í…ŒìŠ¤íŠ¸ê°€ í†µê³¼
- [x] Example 1~4 E2E í…ŒìŠ¤íŠ¸ í†µê³¼
- [x] git commit + push ì™„ë£Œ
- [x] STATUS.mdì— NEXT-10-Î² ë°˜ì˜

**ë‹¤ìŒ ë‹¨ê³„:**
- UI/ë¹„êµ êµ¬ì¡° ê³ ì • í›„ ë³´í—˜ë£Œ ê¸°ëŠ¥ ì„¤ê³„ (data/í˜¸ì¶œ_api/ ì—°ê²°)
- Query Parser êµ¬í˜„ (filter_criteria ìë™ ì±„ìš°ê¸°)
- Comparison Engine ê°œì„  (table_type ìë™ ì„ íƒ)

---
